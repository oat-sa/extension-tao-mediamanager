function _slicedToArray(arr,i){return _arrayWithHoles(arr)||_iterableToArrayLimit(arr,i)||_unsupportedIterableToArray(arr,i)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(arr,i){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(arr)){var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!(i&&_arr.length===i));_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i["return"]||_i["return"]()}finally{if(_d)throw _e}}return _arr}}function _arrayWithHoles(arr){if(Array.isArray(arr))return arr}function _toConsumableArray(arr){return _arrayWithoutHoles(arr)||_iterableToArray(arr)||_unsupportedIterableToArray(arr)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(o,minLen){if(o){if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);return"Object"===n&&o.constructor&&(n=o.constructor.name),"Map"===n||"Set"===n?Array.from(o):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(o,minLen):void 0}}function _iterableToArray(iter){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(iter))return Array.from(iter)}function _arrayWithoutHoles(arr){if(Array.isArray(arr))return _arrayLikeToArray(arr)}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}define("tpl!taoMediaManager/qtiCreator/tpl/relatedItemsPopup",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){function program1(depth0){var stack1,buffer="";return buffer+="<li>"+escapeExpression((stack1=depth0&&depth0.label,"function"===_typeof(stack1)?stack1.apply(depth0):stack1))+"</li>",buffer}this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var stack1,helper,buffer="",escapeExpression=this.escapeExpression,self=this;return(helper=helpers.inUsageMessage)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.inUsageMessage,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\n<ul>\n",stack1=helpers.each.call(depth0,depth0&&depth0.items,{hash:{},inverse:self.noop,fn:self.program(1,program1,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+="\n</ul>\n",(helper=helpers.confirmationMessage)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.confirmationMessage,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1),buffer})}),define("tpl!taoMediaManager/qtiCreator/tpl/relatedItemsClassPopup",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var stack1,helper,options,buffer="",helperMissing=helpers.helperMissing,escapeExpression=this.escapeExpression;return buffer+="<b>"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Warning",options):helperMissing.call(depth0,"__","Warning",options)))+"</b><br><br>\n"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"You are about to delete the class",options):helperMissing.call(depth0,"__","You are about to delete the class",options)))+" <b>",(helper=helpers.name)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.name,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"</b>, "+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"which contains assets that are in use elsewhere.",options):helperMissing.call(depth0,"__","which contains assets that are in use elsewhere.",options)))+"\n"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Deleting this class will break the items and the tests that are currently using them.",options):helperMissing.call(depth0,"__","Deleting this class will break the items and the tests that are currently using them.",options)))+"<br><br>\n"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Are you sure you want to delete this class and all of its content?",options):helperMissing.call(depth0,"__","Are you sure you want to delete this class and all of its content?",options))),buffer})}),define("tpl!taoMediaManager/qtiCreator/tpl/forbiddenClassAction",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var stack1,helper,options,buffer="",helperMissing=helpers.helperMissing,escapeExpression=this.escapeExpression;return buffer+="<b>"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Forbidden action",options):helperMissing.call(depth0,"__","Forbidden action",options)))+"</b><br><br>\n"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"The class",options):helperMissing.call(depth0,"__","The class",options)))+" <b>",(helper=helpers.name)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.name,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"</b> "+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"you are trying to delete is too large and contains too many subclasses.",options):helperMissing.call(depth0,"__","you are trying to delete is too large and contains too many subclasses.",options)))+"<br>\n"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Please delete the subclasses before.",options):helperMissing.call(depth0,"__","Please delete the subclasses before.",options))),buffer})}),define("css!taoMediaManagerCss/media",[],function(){}),define("taoMediaManager/controller/actions",["lodash","jquery","i18n","layout/actions/binder","uri","layout/section","core/request","core/router","core/logger","ui/feedback","ui/dialog/confirm","ui/dialog/alert","util/url","tpl!taoMediaManager/qtiCreator/tpl/relatedItemsPopup","tpl!taoMediaManager/qtiCreator/tpl/relatedItemsClassPopup","tpl!taoMediaManager/qtiCreator/tpl/forbiddenClassAction","css!taoMediaManagerCss/media.css"],function(_,$,__,binder,uri,section,request,router,loggerFactory,feedback,confirmDialog,alertDialog,urlUtil,relatedItemsPopupTpl,relatedItemsClassPopupTpl,forbiddenClassActionTpl){'use strict';function callConfirmModal(actionContext,message,url,data,resolve,reject){confirmDialog(message,function(){return accept(actionContext,url,data,resolve,reject)},function(){return cancel(reject)})}function callAlertModal(actionContext,message,reject){alertDialog(message,function(){return cancel(reject)})}function accept(actionContext,url,data,resolve,reject){return request({url:url,method:"POST",data:data,dataType:"json"}).then(function(response){return response.success&&response.deleted?(feedback().success(response.message||__("Resource deleted")),actionContext.tree&&$(actionContext.tree).trigger("removenode.taotree",[{id:actionContext.uri||actionContext.classUri}]),resolve({uri:actionContext.uri||actionContext.classUri})):void(response.success&&!response.deleted&&($(actionContext.tree).trigger("refresh.taotree"),reject(response.msg||response.message||__("Unable to delete the selected resource because you do not have the required rights to delete part of its content."))),reject(response.msg||response.message||__("Unable to delete the selected resource")))})}function cancel(reject){reject({cancel:!0})}var logger=loggerFactory("taoMediaManager/manageMedia");binder.register("newSharedStimulus",function(actionContext){var self=this,classUri=uri.decode(actionContext.classUri);return request({url:self.url,data:JSON.stringify({classUri:classUri}),method:"POST"}).then(function(response){return actionContext.tree&&$(actionContext.tree).trigger("addnode.taotree",[{uri:uri.decode(response.data.id),label:response.data.name,parent:uri.decode(actionContext.classUri),cssClass:"node-instance"}]),{uri:uri.decode(response.data.id),label:response.data.name,classUri:uri.decode(actionContext.classUri),type:"instance"}}).catch(function(err){_.isUndefined(err.message)||feedback().error(err.message),logger.error(err)})}),binder.register("sharedStimulusAuthoring",function(actionContext){section.updateContentBlock("").create({id:"authoring",name:__("Authoring"),url:this.url,content:" ",visible:!1}).show();var $panel=$("#panel-authoring");$panel.attr("data-id",actionContext.id),$panel.attr("data-uri",actionContext.uri),router.dispatch("".concat(this.url,"?id=").concat(actionContext.id))}),binder.register("deleteSharedStimulus",function(actionContext){var self=this,data={},mediaRelationsData={type:"media"};return"instance"===actionContext.context[0]?mediaRelationsData.sourceId=actionContext.id:mediaRelationsData.classId=actionContext.id,data.uri=uri.decode(actionContext.uri),data.classUri=uri.decode(actionContext.classUri),data.id=actionContext.id,data.signature=actionContext.signature,new Promise(function(resolve,reject){request({url:urlUtil.route("index","ResourceRelations","tao"),data:mediaRelationsData,method:"GET",noToken:!0}).then(function(responseRelated){var message,haveItemReferences=responseRelated.data.relations,name=$("a.clicked",actionContext.tree).text().trim();"instance"===actionContext.context[0]?0===haveItemReferences.length?message="".concat(__("Are you sure you want to delete this")," <b>").concat(name,"</b>?"):message=relatedItemsPopupTpl({name:name,inUsageMessage:__("This \"%s\" is currently used in %d item(s)",name,haveItemReferences.length),confirmationMessage:__("Are you sure you want to delete this \"%s\"?",name),items:haveItemReferences}):"instance"!==actionContext.context[0]&&(0===haveItemReferences.length?message="".concat(__("Are you sure you want to delete this class and all of its content?")):0!==haveItemReferences.length&&(message=relatedItemsClassPopupTpl({name:name,number:haveItemReferences.length,items:haveItemReferences}))),callConfirmModal(actionContext,message,self.url,data,resolve,reject)}).catch(function(errorObject){var message;"class"===actionContext.context[0]&&999===errorObject.response.code&&(message=forbiddenClassActionTpl()),callAlertModal(actionContext,message,reject)})})})}),define("taoMediaManager/qtiCreator/helper/createDummyItemData",["taoQtiItem/qtiCreator/model/Item"],function(Item){'use strict';var _generateIdentifier=function(uri){var pos=uri.lastIndexOf("#");return uri.substr(pos+1)};return function creatorDummyItemData(sharedStimulusData){var newItem=new Item().id(_generateIdentifier(sharedStimulusData.id)).attr("title",sharedStimulusData.name);newItem.data("new",!0),newItem.data("dummy",!0);var itemData=Object.assign({},newItem);return delete itemData.bdy,delete itemData.rootElement,itemData.body=sharedStimulusData.body.body,itemData.qtiClass="assessmentItem",itemData.responseProcessing={attributes:{},qtiClass:"responseProcessing",responseRules:[],serial:"response_".concat(sharedStimulusData.body.serial)},itemData.response={},sharedStimulusData.body.attributes["xml:lang"]&&(itemData.attributes["xml:lang"]=sharedStimulusData.body.attributes["xml:lang"]),sharedStimulusData.body.attributes.class&&(itemData.attributes.class=sharedStimulusData.body.attributes.class),itemData}}),define("taoMediaManager/qtiCreator/helper/sharedStimulusLoader",["jquery","taoQtiItem/qtiItem/core/Loader","taoQtiItem/qtiCreator/model/qtiClasses","taoMediaManager/qtiCreator/helper/createDummyItemData","core/dataProvider/request","util/url"],function($,Loader,qtiClasses,creatorDummyItemData,request,urlUtil){'use strict';var qtiSchemaLocation={"http://www.imsglobal.org/xsd/imsqti_v2p2":"http://www.imsglobal.org/xsd/qti/qtiv2p2/imsqti_v2p2.xsd"},languagesUrl=urlUtil.route("index","Languages","tao");return{loadSharedStimulus:function loadSharedStimulus(config,callback){if(config.id){var languagesList=request(languagesUrl),assetData=request(config.assetDataUrl,{id:config.id});Promise.all([languagesList,assetData]).then(function(values){var loader,itemData;itemData=creatorDummyItemData(values[1]),loader=new Loader().setClassesLocation(qtiClasses),loader.loadItemData(itemData,function(loadedItem){var namespaces;namespaces=loadedItem.getNamespaces(),namespaces[""]="http://www.imsglobal.org/xsd/imsqti_v2p2",loadedItem.setNamespaces(namespaces),loadedItem.setSchemaLocations(qtiSchemaLocation),languagesList&&loadedItem.data("languagesList",values[0]),callback(loadedItem,this.getLoadedClasses())})})}}}}),define("taoMediaManager/qtiCreator/renderers/config",["lodash","taoQtiItem/qtiCommonRenderer/renderers/config","taoItems/assets/manager","taoItems/assets/strategies"],function(_,commonRenderConfig,assetManagerFactory,assetStrategies){'use strict';var assetManager=assetManagerFactory([assetStrategies.taomedia,assetStrategies.external,assetStrategies.base64,assetStrategies.baseUrl],{baseUrl:""}),locations=_.defaults({_container:"taoQtiItem/qtiCreator/renderers/Container",_tooltip:"taoQtiItem/qtiCreator/renderers/Tooltip",assessmentItem:"taoMediaManager/qtiCreator/renderers/Item",figure:"taoMediaManager/qtiCreator/renderers/Figure",img:"taoMediaManager/qtiCreator/renderers/Img",figcaption:"taoMediaManager/qtiCreator/renderers/Figcaption",math:"taoQtiItem/qtiCreator/renderers/Math",object:"taoMediaManager/qtiCreator/renderers/Object",table:"taoMediaManager/qtiCreator/renderers/Table"},commonRenderConfig.locations);return{name:"creatorRenderer",locations:locations,options:{assetManager:assetManager}}}),define("taoMediaManager/qtiCreator/renderers/Renderer",["taoQtiItem/qtiRunner/core/Renderer","taoMediaManager/qtiCreator/renderers/config"],function(Renderer,config){'use strict';return Renderer.build(config.locations,config.name,config.options)}),define("taoMediaManager/qtiCreator/helper/creatorRenderer",["jquery","lodash","taoMediaManager/qtiCreator/renderers/Renderer","taoItems/assets/manager","taoItems/assets/strategies","util/dom"],function($,_,Renderer,assetManagerFactory,assetStrategies,dom){'use strict';var creatorRenderer=null,get=function(reset,config,areaBroker){var $bodyEltForm;return config=config||{},config.properties=config.properties||{},(!creatorRenderer||reset)&&($bodyEltForm=creatorRenderer?creatorRenderer.getOption("bodyElementOptionForm"):null,(reset||!$bodyEltForm||!$bodyEltForm.length||!dom.contains($bodyEltForm))&&(creatorRenderer=new Renderer({lang:"",uri:"",shuffleChoices:!1,itemOptionForm:$("#item-editor-item-property-bar #sidebar-right-passage-properties .panel"),bodyElementOptionForm:areaBroker.getElementPropertyPanelArea(),textOptionForm:$("#item-editor-text-property-bar #sidebar-right-text-block-properties .panel"),mediaManager:{appendContainer:"#mediaManager",browseUrl:config.properties.getFilesUrl,uploadUrl:config.properties.fileUploadUrl,deleteUrl:config.properties.fileDeleteUrl,downloadUrl:config.properties.fileDownloadUrl,fileExistsUrl:config.properties.fileExistsUrl,path:config.properties.path,root:config.properties.root},qtiCreatorContext:config.qtiCreatorContext,locations:config.properties.locations}),creatorRenderer.getAssetManager().setData({baseUrl:config.properties.baseUrl||""}),creatorRenderer.setAreaBroker(areaBroker),_.assign(creatorRenderer,{getCreatorContext:function(){return this.getOption("qtiCreatorContext")}}))),creatorRenderer};return{get:get,setOption:function setOption(name,value){return get().setOption(name,value)},setOptions:function setOptions(options){return get().setOptions(options)},load:function load(qtiClasses,done){return get().load(function(){if(_.isFunction(done)){for(var _len=arguments.length,rest=Array(_len),_key=0;_key<_len;_key++)rest[_key]=arguments[_key];done.apply(this,rest)}},qtiClasses)}}}),define("tpl!taoMediaManager/qtiCreator/tpl/toolbars/cssToggler",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var stack1,helper,buffer="",escapeExpression=this.escapeExpression;return buffer+="<li data-css-res=\"",(helper=helpers.path)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.path,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\">\n    <span class=\"icon-preview style-sheet-toggler\" title=\"",(helper=helpers.title)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.title,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\"></span>\n    <span class=\"file-label truncate\" title=\"",(helper=helpers.editLabelTxt)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.editLabelTxt,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\">",(helper=helpers.label)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.label,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"</span>\n    <input type=\"text\" class=\"style-sheet-label-editor\" value=\"",(helper=helpers.label)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.label,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\">\n    <span class=\"icon-bin\" title=\"",(helper=helpers.deleteTxt)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.deleteTxt,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\" data-role=\"css-delete\"></span>\n    <span class=\"icon-download\" title=\"",(helper=helpers.downloadTxt)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.downloadTxt,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\" data-role=\"css-download\"></span>\n</li>",buffer})}),define("taoMediaManager/qtiCreator/editor/styleEditor/styleEditor",["jquery","lodash","i18n","util/urlParser","core/dataProvider/request","tpl!taoMediaManager/qtiCreator/tpl/toolbars/cssToggler","jquery.fileDownload"],function($,_,__,UrlParser,request,cssTpl){'use strict';var itemConfig,globalConfig,currentItem,_getUri=function(action){return globalConfig["".concat(action,"CssUrl")]},_basename=function(path){return path.substring(path.lastIndexOf("/")+1)},hashClassSelector="hashClass",hashClass="",style={},customStylesheet="",$styleElem=function(){var styleElem=$("#item-editor-user-styles");return styleElem.length?styleElem.empty():(styleElem=$("<style>",{id:"item-editor-user-styles"}),$("head").append(styleElem)),styleElem}(),common={title:__("Disable this stylesheet temporarily"),deleteTxt:__("Remove this stylesheet"),editLabelTxt:__("Edit stylesheet label"),downloadTxt:__("Download this stylesheet"),preparingMessageHtml:__("Preparing CSS, please wait\u2026"),failMessageHtml:__("There was a problem downloading your CSS, please try again."),isInValidLocalTxt:__("This stylesheet has not been found on the server. you may want to delete this reference")},erase=function(){return style={},$styleElem.text(""),!1},create=function(dontAppend){var mSelector,mProp,css="";return _.isEmpty(style)?erase():(_.forEach(style,function(value1,key1){css+="".concat(key1,"{"),_.forEach(value1,function(value2,key2){if(_.isPlainObject(value2))for(mSelector in value2){for(mProp in css+="".concat(key2,"{"),value2)css+="".concat(mProp,":").concat(value2[mSelector],";");css+="}"}else css+="".concat(key2,":").concat(value2,";")}),css+="}\n"}),dontAppend||$styleElem.text(css),css)},apply=function(selector,property,value){selector=selector.replace(hashClassSelector,hashClass),style[selector]=style[selector]||{},value?style[selector][property]=value:(delete style[selector][property],0===_.size(style[selector])&&delete style[selector]),create(),$(document).trigger("stylechange.qti-creator")},verifyInit=function(){if(!itemConfig)throw new Error("Missing itemConfig, did you call styleEditor.init()?");return!0},save=function(){return verifyInit(),request(_getUri("save"),_.extend({},itemConfig,{cssJson:JSON.stringify(style),stylesheetUri:customStylesheet.attr("href")}),"POST")},download=function(uri){verifyInit(),$.fileDownload(_getUri("download"),{preparingMessageHtml:common.preparingMessageHtml,failMessageHtml:common.failMessageHtml,successCallback:function successCallback(){},httpMethod:"POST",data:_.extend({},itemConfig,{stylesheetUri:uri})})},addStylesheet=function(stylesheet){function loadStylesheet(linkElement,stylesheetObject,isLocal,isValid){var isInvalidLocal=isLocal&&!isValid,tplData={path:stylesheetObject.attr("href"),label:stylesheetObject.attr("title")||fileName,title:common.title,deleteTxt:common.deleteTxt,downloadTxt:common.downloadTxt,editLabelTxt:isInvalidLocal?common.isInValidLocalTxt:common.editLabelTxt};return listEntry=$(cssTpl(tplData)),listEntry.data("stylesheetObj",stylesheetObject),$("#style-sheet-toggler").append(listEntry),isInvalidLocal?(listEntry.addClass("not-available"),void listEntry.find("[data-role=\"css-download\"], .style-sheet-toggler").css("visibility","hidden")):void($styleElem.before(linkElement),setTimeout(function(){var isInit=!1;$(document).trigger("customcssloaded.styleeditor",[style]),$(window).trigger("resize"),currentItem.pendingStylesheetsInit&&(isInit=!0,currentItem.pendingStylesheetsInit--),$(document).trigger("stylechange.qti-creator",[{initializing:isInit}])},isLocal?500:3500))}var fileName,link,listEntry,parser;_.isString(stylesheet)&&(stylesheet=currentItem.createStyleSheet(stylesheet)),fileName=_basename(stylesheet.attr("href")),link=function(){var _link=$(stylesheet.render()),_href=_link.attr("href"),_sep=-1<_href.indexOf("?")?"&":"?";return _link.attr("href",_href+_sep+new Date().getTime().toString()),_link}(),parser=new UrlParser(link.attr("href")),parser.checkCORS()?$.when($.ajax(link.attr("href"))).then(function(){loadStylesheet(link,stylesheet,!0,!0)},function(){loadStylesheet(link,stylesheet,!0,!1)}):loadStylesheet(link,stylesheet,!1)},addItemStylesheets=function(){var currentStylesheet;currentItem.pendingStylesheetsInit=_.size(currentItem.stylesheets),_.forEach(currentItem.stylesheets,function(value){currentStylesheet=value,"tao-user-styles.css"===_basename(currentStylesheet.attr("href"))?customStylesheet=currentStylesheet:addStylesheet(value)}),customStylesheet||(customStylesheet=currentItem.createStyleSheet("css/tao-user-styles.css"))},removeOrphanedStylesheets=function(){$("link[data-serial]").remove(),customStylesheet=null,erase()},getItem=function(){return currentItem},init=function(item,config){var href;globalConfig=config,currentItem=item,itemConfig={uri:config.id,lang:config.lang},removeOrphanedStylesheets(),addItemStylesheets(),href=customStylesheet.attr("href"),currentItem.data("responsive",!0),request(_getUri("load"),_.extend({},itemConfig,{stylesheetUri:href})).then(function(_style){style=_style,create(),$(document).trigger("customcssloaded.styleeditor",[style])})},getStyle=function(){return style},getHashClass=function(){return hashClass},replaceHashClass=function(selector){return selector.replace(hashClassSelector,hashClass)};return{apply:apply,save:save,download:download,erase:erase,init:init,create:create,getItem:getItem,getStyle:getStyle,addStylesheet:addStylesheet,getHashClass:getHashClass,setHashClass:function setHashClass(cssClass){hashClass=cssClass},generateHashClass:function generateHashClass(){return hashClass="".concat("tao-").concat(Math.random().toString(36).substr(2,9))},replaceHashClass:replaceHashClass,clearCache:function clearCache(){removeOrphanedStylesheets(),$(document).off("customcssloaded.styleeditor")}}}),define("taoMediaManager/qtiCreator/editor/styleEditor/styleSheetToggler",["jquery","taoMediaManager/qtiCreator/editor/styleEditor/styleEditor","i18n","lodash","taoQtiItem/qtiCreator/model/Stylesheet","tpl!taoQtiItem/qtiCreator/tpl/notifications/genericFeedbackPopup","ui/resourcemgr"],function($,styleEditor,__,_,Stylesheet,genericFeedbackPopup){'use strict';var $doc=$(document),styleSheetToggler=function(){var _createInfoBox=function(data){var $messageBox=$(genericFeedbackPopup(data)),closeTrigger=$messageBox.find(".close-trigger");return $("body").append($messageBox),closeTrigger.on("click",function(){$messageBox.fadeOut(function(){$(this).remove()})}),setTimeout(function(){closeTrigger.trigger("click")},4523),$messageBox};return{init:function init(itemConfig){var cssToggler=$("#style-sheet-toggler"),uploader=$("#stylesheet-uploader"),customCssToggler=$("[data-custom-css]"),getContext=function(trigger){trigger=$(trigger);var li=trigger.closest("li"),stylesheetObj=li.data("stylesheetObj")||new Stylesheet({href:li.data("css-res")}),input=li.find(".style-sheet-label-editor"),labelBox=input.prev(".file-label"),label=input.val();return{li:li,input:input,label:label,labelBox:labelBox,isCustomCss:!!li.data("custom-css"),isDisabled:li.find(".icon-preview").hasClass("disabled"),stylesheetObj:stylesheetObj,cssUri:stylesheetObj.attr("href")}};uploader.on("click",function(){uploader.resourcemgr({appendContainer:"#mediaManager",path:"/",root:"local",browseUrl:itemConfig.getFilesUrl,uploadUrl:itemConfig.fileUploadUrl,deleteUrl:itemConfig.fileDeleteUrl,downloadUrl:itemConfig.fileDownloadUrl,fileExistsUrl:itemConfig.fileExistsUrl,params:{uri:itemConfig.uri,lang:itemConfig.lang,filters:"text/css"},pathParam:"path",select:function select(e,files){var i,l=files.length;for(i=0;i<l;i++)styleEditor.addStylesheet(files[i].file)}})});var deleteStylesheet=function(trigger){var context=getContext(trigger),attr=context.isDisabled?"disabled-href":"href",cssLinks=$("head link");styleEditor.getItem().removeStyleSheet(context.stylesheetObj),cssLinks.filter("["+attr+"*=\""+context.cssUri+"\"]").remove(),context.li.remove(),$(".feedback-info").hide(),_createInfoBox({message:__("Style Sheet <b>%s</b> removed<br> Click <i>Add Style Sheet</i> to re-apply.").replace("%s",context.label),type:"info"}),$doc.trigger("customcssloaded.styleeditor",[styleEditor.getStyle()])},initLabelEditor=function(trigger){var context=getContext(trigger);context.labelBox.hide(),context.input.show()},downloadStylesheet=function(trigger){styleEditor.download(getContext(trigger).cssUri)},saveLabel=function(trigger){var context=getContext(trigger),title=$.trim(context.input.val());return title?void(context.stylesheetObj.attr("title",title),context.input.hide(),context.labelBox.html(title).show()):(context.stylesheetObj.attr("title",""),!1)},handleAvailability=function(trigger){var link,context=getContext(trigger),attrTo="disabled-href",attrFrom="href";context.isCustomCss?context.isDisabled?(styleEditor.create(),customCssToggler.removeClass("not-available")):(styleEditor.erase(),customCssToggler.addClass("not-available")):(context.isDisabled&&(attrTo="href",attrFrom="disabled-href"),link=$("link["+attrFrom+"$=\""+context.cssUri+"\"]"),link.attr(attrTo,link.attr(attrFrom)).removeAttr(attrFrom)),$(trigger).toggleClass("disabled")};cssToggler.on("click",function(e){var target=e.target,className=target.className;-1<className.indexOf("icon-bin")?deleteStylesheet(e.target):-1<className.indexOf("file-label")?initLabelEditor(e.target):-1<className.indexOf("icon-preview")?handleAvailability(e.target):-1<className.indexOf("icon-download")&&downloadStylesheet(e.target)}),cssToggler.on("keydown","input",function(e){13===e.keyCode&&$(e.target).trigger("blur")}),cssToggler.on("blur","input",function(e){saveLabel(e.target)})}}}();return styleSheetToggler}),define("taoMediaManager/qtiCreator/editor/styleEditor/fontSelector",["jquery","lodash","json!taoQtiItem/qtiCreator/editor/resources/font-stacks.json","taoMediaManager/qtiCreator/editor/styleEditor/styleEditor","i18n","select2"],function($,_,fontStacks,styleEditor,__){'use strict';return function fontSelector($container){var $selector=$container.find("select#item-editor-font-selector"),target=styleEditor.replaceHashClass($selector.data("target")),normalize=function(font){return font.replace(/"/g,"'").replace(/, /g,",")},clean=function(font){return font.substring(0,font.indexOf(",")).replace(/'/g,"").replace(/"/g,"")},resetButton=$selector.parent().find("[data-role=\"font-selector-reset\"]"),toLabel=function(font){return font=font.replace(/-/g," "),font.replace(/^([a-z\u00E0-\u00FC])|\s+([a-z\u00E0-\u00FC])/g,function($1){return $1.toUpperCase()})},format=function(state){var originalOption=state.element;return state.id?"<span style=\"font-size: 12px;".concat($(originalOption).attr("style"),"\">").concat(state.text,"</span>"):state.text},applyToStylesEditor=!0;$selector.empty(),$selector.append("<option value=\"\">".concat(__("Default"),"</option>"));var styles=styleEditor.getStyle()||{},selectedFontFamily=styles[target]&&styles[target]["font-family"]&&clean(styles[target]["font-family"]);_.forEach(fontStacks,function(value,key){var optGroup=$("<optgroup>",{label:toLabel(key)});_.forEach(value,function(font){var normalizeFont=normalize(font),option=$("<option>",{value:normalizeFont,text:clean(normalizeFont)}).css({fontFamily:normalizeFont});clean(normalizeFont)===selectedFontFamily&&option.attr("selected",!0),optGroup.append(option)}),$selector.append(optGroup)}),resetButton.off("click").on("click",function reset(){styleEditor.apply(target,"font-family"),$selector.select2("val","")}),$selector.select2({formatResult:format,formatSelection:format,width:"resolve"}),$selector.off("change").on("change",function(){applyToStylesEditor?styleEditor.apply(target,"font-family",$(this).val()):applyToStylesEditor=!0}),$(document).on("customcssloaded.styleeditor",function(e,style){style[target]&&style[target]["font-family"]&&($selector.select2("val",style[target]["font-family"]),$("".concat("select#item-editor-font-selector"," option:selected")).first().attr("selected","selected")),applyToStylesEditor=!1,$selector.trigger("change")})}}),define("taoMediaManager/qtiCreator/editor/styleEditor/colorSelector",["jquery","lodash","i18n","taoMediaManager/qtiCreator/editor/styleEditor/styleEditor","taoQtiItem/qtiCreator/helper/popup","lib/farbtastic/farbtastic"],function($,_,__,styleEditor){'use strict';function rgbToHex(color){function toHexPair(inp){return"0".concat(parseInt(inp,10).toString(16)).slice(-2)}if(!_.isString(color))return color;var rgbArr=/rgb\s*\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*\)/i.exec(color);return _.isArray(rgbArr)&&4===rgbArr.length?"#".concat(toHexPair(rgbArr[1])).concat(toHexPair(rgbArr[2])).concat(toHexPair(rgbArr[3])):color}function additionalStylesToObject(){var additional=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",styles={},additionalStyles=additional.split(";");return additionalStyles.forEach(function(element){var keyValue=element.split(":");styles[keyValue[0]]=keyValue[1]}),styles}return function colorSelector($container){var widgetObj,colorPicker=$container.find(".item-editor-color-picker"),widget=colorPicker.find(".color-picker"),widgetBox=colorPicker.find(".color-picker-container"),titleElement=colorPicker.find(".color-picker-title"),input=colorPicker.find(".color-picker-input"),resetButtons=colorPicker.find(".reset-button"),colorTriggers=colorPicker.find(".color-trigger"),colorTriggerLabels=colorPicker.find("label"),$doc=$(document),additionalStyles={},currentProperty="color",setTitle=function(property,trigger){titleElement.text(trigger.parent().find("label").text())},setTriggerColor=function(){colorTriggers.each(function(){var value,$trigger=$(this),target=styleEditor.replaceHashClass($trigger.data("target")),style=styleEditor.getStyle()||{};style[target]&&style[target][$trigger.data("value")]?(value=style[target][$trigger.data("value")],$trigger.css("background-color",value),$trigger.attr("title",rgbToHex(value))):($trigger.css("background-color",""),$trigger.attr("title",__("No value set")))})};widgetObj=$.farbtastic(widget).linkTo(input),setTriggerColor(),function collectCommonAdditionalStyles(){colorTriggers.each(function(){var $trigger=$(this),target=styleEditor.replaceHashClass($trigger.data("target")),value=$trigger.data("value"),styles=additionalStylesToObject($trigger.data("additional"));Object.keys(styles).forEach(function(key){additionalStyles[key]?additionalStyles[key].push({target:target,value:value}):additionalStyles[key]=[{target:target,value:value}]})})}(),colorTriggers.add(colorTriggerLabels).off("click").on("click",function(){var $tmpTrigger=$(this),$trigger="label"===this.nodeName.toLowerCase()?$tmpTrigger.parent().find(".color-trigger"):$tmpTrigger;widget.prop("target",$trigger.data("target")),widget.prop("additional",$trigger.data("additional")||""),widgetBox.hide(),currentProperty=$trigger.data("value"),setTitle(currentProperty,$trigger),widgetObj.setColor(rgbToHex($trigger.css("background-color"))),widgetBox.show(),widget.on("colorchange.farbtastic",function(e,color){if(styleEditor.apply(widget.prop("target"),currentProperty,color),widget.prop("additional")){var styles=additionalStylesToObject(widget.prop("additional"));Object.keys(styles).forEach(function(key){styleEditor.apply(widget.prop("target"),key,styles[key])})}setTriggerColor()}),$doc.on("mouseup.colorselector",function(e){return $(e.target).hasClass("closer")?(widgetBox.hide(),widget.off("colorchange.farbtastic"),$doc.off("colorselector"),!1):widgetBox.is(e.target)||0!==widgetBox.has(e.target).length?void 0:(widgetBox.hide(),widget.off("colorchange.farbtastic"),$doc.off("colorselector"),!1)}),$doc.on("keyup.colorselector",function(e){if(27===e.keyCode)return widgetBox.hide(),widget.off("colorchange.farbtastic"),$doc.off("colorselector"),!1})}),resetButtons.off("click").on("click",function(){var $this=$(this),$colorTrigger=$this.parent().find(".color-trigger"),target=styleEditor.replaceHashClass($colorTrigger.data("target")),value=$colorTrigger.data("value"),additional=$colorTrigger.data("additional");if(styleEditor.apply(target,value),additional){var styles=additionalStylesToObject(additional);Object.keys(styles).forEach(function(key){if(1===additionalStyles[key].length)styleEditor.apply(target,key);else{var style=styleEditor.getStyle()||{},needToRemove=!0;additionalStyles[key].forEach(function(element){(target!==element.target||value!==element.value)&&style[target]&&style[element.target][element.value]&&(needToRemove=!1)}),needToRemove&&styleEditor.apply(target,key)}})}setTriggerColor()}),$doc.on("customcssloaded.styleeditor",setTriggerColor)}}),define("taoMediaManager/qtiCreator/editor/styleEditor/fontSizeChanger",["jquery","lodash","taoMediaManager/qtiCreator/editor/styleEditor/styleEditor"],function($,_,styleEditor){'use strict';return function fontSizeChanger($container){var $fontSizeChanger=$container.find("#item-editor-font-size-changer"),itemSelector=styleEditor.replaceHashClass($fontSizeChanger.data("target")),figcaptionSelector="".concat(itemSelector," figure figcaption"),$resetBtn=$fontSizeChanger.parents(".reset-group").find("[data-role=\"font-size-reset\"]"),$input=$container.find(".item-editor-font-size-text"),itemFontSize=parseInt($(itemSelector).css("font-size"),10),styles=styleEditor.getStyle()||{};styles[itemSelector]&&styles[itemSelector]["font-size"]?(itemFontSize=parseInt(styles[itemSelector]["font-size"],10),$input.val(itemFontSize)):$input.val("");var resizeFont=function(){styleEditor.apply(itemSelector,"font-size","".concat(itemFontSize.toString(),"px"));var figcaptionSize=14<itemFontSize?(itemFontSize-2).toString():Math.min(itemFontSize,12).toString();styleEditor.apply(figcaptionSelector,"font-size","".concat(figcaptionSize,"px"))};$fontSizeChanger.find("button").off("click").on("click",function(e){if(e.preventDefault(),"reduce"===$(this).data("action")){if(10>=itemFontSize)return;itemFontSize--}else itemFontSize++;resizeFont(),$input.val(itemFontSize),$(this).parent().blur()}),$input.off("blur").on("blur",function(){this.value?(itemFontSize=parseInt(this.value,10),resizeFont()):(styleEditor.apply(itemSelector,"font-size"),styleEditor.apply(figcaptionSelector,"font-size"))}),$input.off("keydown").on("keydown",function(e){var c=e.keyCode;return 13===c&&$input.trigger("blur"),_.contains([8,37,39,46],c)||48<=c&&57>=c||96<=c&&105>=c}),$resetBtn.off("click").on("click",function(){styleEditor.apply(itemSelector,"font-size"),styleEditor.apply(figcaptionSelector,"font-size"),$input.val(""),itemFontSize=parseInt($(itemSelector).css("font-size"),10)}),$(document).on("customcssloaded.styleeditor",function(e,style){style[itemSelector]&&style[itemSelector]["font-size"]?(itemFontSize=parseInt(style[itemSelector]["font-size"],10),$input.val(itemFontSize)):$input.val("")})}}),define("taoMediaManager/qtiCreator/editor/propertiesPanel",["jquery","taoQtiItem/qtiCreator/helper/panel","taoMediaManager/qtiCreator/editor/styleEditor/styleEditor","taoMediaManager/qtiCreator/editor/styleEditor/styleSheetToggler","taoMediaManager/qtiCreator/editor/styleEditor/fontSelector","taoMediaManager/qtiCreator/editor/styleEditor/colorSelector","taoMediaManager/qtiCreator/editor/styleEditor/fontSizeChanger"],function($,panel,styleEditor,styleSheetToggler,fontSelector,colorSelector,fontSizeChanger){'use strict';return function($container,widget,config){panel.initSidebarAccordion($container),panel.initFormVisibilityListener(),styleEditor.init(widget.element,config),styleSheetToggler.init(config);var $passageEditor=$("#item-editor-item-property-bar");fontSelector($passageEditor),colorSelector($passageEditor),fontSizeChanger($passageEditor)}}),define("taoMediaManager/qtiXmlRenderer/renderers/config",["taoItems/assets/manager"],function(assetManagerFactory){'use strict';var assetManager=assetManagerFactory([{name:"nomalize",handle:function(url){if(url)return url.toString().replace(/^\.?\//,"")}}]);return{name:"xmlRenderer",locations:{_container:"taoQtiItem/qtiXmlRenderer/renderers/Container",assessmentItem:"taoMediaManager/qtiXmlRenderer/renderers/Item",_tooltip:"taoQtiItem/qtiXmlRenderer/renderers/Tooltip",math:"taoQtiItem/qtiXmlRenderer/renderers/Math",figure:"taoQtiItem/qtiXmlRenderer/renderers/Figure",img:"taoQtiItem/qtiXmlRenderer/renderers/Img",figcaption:"taoQtiItem/qtiXmlRenderer/renderers/Figcaption",object:"taoQtiItem/qtiXmlRenderer/renderers/Object",table:"taoQtiItem/qtiXmlRenderer/renderers/Table"},options:{assetManager:assetManager}}}),define("taoMediaManager/qtiXmlRenderer/renderers/Renderer",["taoQtiItem/qtiRunner/core/Renderer","taoMediaManager/qtiXmlRenderer/renderers/config"],function(Renderer,config){'use strict';return Renderer.build(config.locations,config.name,config.options)}),define("taoMediaManager/qtiCreator/helper/xmlRenderer",["core/logger","taoMediaManager/qtiXmlRenderer/renderers/Renderer","taoQtiItem/qtiItem/core/Element"],function(loggerFactory,XmlRenderer,Element){'use strict';var logger=loggerFactory("taoMediaManager/qtiCreator/helper/xmlRenderer"),_xmlRenderer=new XmlRenderer().load();return{render:function _render(element){var xml="";try{element instanceof Element&&(xml=element.render(_xmlRenderer))}catch(e){logger.error(e)}return xml},get:function get(){return _xmlRenderer}}}),define("taoMediaManager/qtiCreator/editor/interactionsPanel",["lodash","i18n","taoQtiItem/qtiCreator/editor/interactionsToolbar","taoQtiItem/qtiCreator/helper/panel"],function(_,__,interactionsToolbar,panel){'use strict';return function($container){var tagTitles={inlineInteractions:__("Inline Interactions")},interactions={_container:{label:__("Text Block"),icon:"icon-font",description:__("Block contains the content (stimulus) of the item such as text or image. It is also required for Inline Interactions."),short:__("Block"),qtiClass:"_container",tags:[tagTitles.inlineInteractions,"text"],group:__("inline-interactions")}};interactionsToolbar.create($container,interactions),panel.initSidebarAccordion($container),panel.toggleInlineInteractionGroup()}}),define("taoMediaManager/qtiCreator/sharedStimulusCreator",["jquery","lodash","i18n","core/eventifier","taoQtiItem/qtiCreator/context/qtiCreatorContext","taoMediaManager/qtiCreator/helper/sharedStimulusLoader","taoMediaManager/qtiCreator/helper/creatorRenderer","taoQtiItem/qtiCreator/helper/commonRenderer","taoMediaManager/qtiCreator/editor/propertiesPanel","taoQtiItem/qtiCreator/model/helper/event","taoMediaManager/qtiCreator/helper/xmlRenderer","taoQtiItem/qtiItem/helper/xmlNsHandler","core/request","util/url","taoMediaManager/qtiCreator/editor/interactionsPanel","taoMediaManager/qtiCreator/editor/styleEditor/styleEditor","taoQtiItem/qtiItem/core/Element"],function($,_,__,eventifier,qtiCreatorContextFactory,sharedStimulusLoader,creatorRenderer,commonRenderer,propertiesPanel,eventHelper,xmlRenderer,xmlNsHandler,request,urlUtil,interactionPanel,styleEditor,Element){'use strict';var loadSharedStimulus=function(id,uri,assetDataUrl){return new Promise(function(resolve,reject){sharedStimulusLoader.loadSharedStimulus({id:id,uri:uri,assetDataUrl:assetDataUrl},function(item){item||reject(new Error("Unable to load the Shared Stimulus")),item.data("uri",uri),resolve(item)})})};return function(config,areaBroker,pluginFactories){var sharedStimulusCreator,qtiCreatorContext=qtiCreatorContextFactory(),plugins={},pluginRun=function(method){var execStack=[];return _.forEach(plugins,function(plugin){_.isFunction(plugin[method])&&execStack.push(plugin[method]())}),Promise.all(execStack)};if(!_.isPlainObject(config))throw new TypeError("The shared stimulus creator configuration is required");if(!config.properties||_.isEmpty(config.properties.uri)||_.isEmpty(config.properties.baseUrl))throw new TypeError("The creator configuration must contains the required properties triples: uri, label and baseUrl");if(!areaBroker)throw new TypeError("Without an areaBroker there are no chance to see something you know");return sharedStimulusCreator=eventifier({init:function init(){var _this=this;return _.forEach(pluginFactories,function(pluginFactory){var plugin=pluginFactory(_this,areaBroker);plugins[plugin.getName()]=plugin}),$(document).off(".qti-widget"),this.on("save",function(silent){var item=_this.getItem(),styles=styleEditor.getStyle();_.size(styles)&&!item.attributes.class&&(item.attributes.class=_this.hashClass);var xml=xmlNsHandler.restoreNs(xmlRenderer.render(item),item.getNamespaces());Promise.all([request({url:urlUtil.route("patch","SharedStimulus","taoMediaManager",{id:config.properties.id}),type:"POST",contentType:"application/json",dataType:"json",data:JSON.stringify({body:xml}),method:"PATCH",noToken:!0}),styleEditor.save()]).then(function(){silent||_this.trigger("success"),_this.trigger("saved")}).catch(function(err){_this.trigger("error",err)})}),this.on("exit",function(){$(".item-editor-item",areaBroker.getItemPanelArea()).empty(),this.destroy()}),loadSharedStimulus(config.properties.id,config.properties.uri,config.properties.assetDataUrl).then(function(item){return _.isObject(item)?void(_this.item=item):void _this.trigger("error",new Error("Unable to load the item ".concat(config.properties.label)))}).then(function(){return pluginRun("init")}).then(function(){_this.trigger("init",_this.item)}).then(function(){return qtiCreatorContext.on("error",function(err){_this.trigger("error",err)}),qtiCreatorContext.init()}).catch(function(err){_this.trigger("error",err)}),this},render:function render(){var _this2=this,self=this,item=this.getItem();return item&&_.isFunction(item.getUsedClasses)?(commonRenderer.setContext(areaBroker.getItemPanelArea()),commonRenderer.get(!0,config).setOption("baseUrl",config.properties.baseUrl),interactionPanel(areaBroker.getInteractionPanelArea()),$(document).on("ready.qti-widget",function(e,elt){"assessmentItem"===elt.element.qtiClass&&_this2.trigger("ready")}),$(document).on("afterStateInit.qti-widget",function(e,element,state){if(element.getRootElement().data("widget")){var $itemContainer=element.getRootElement().data("widget").$container;switch(state.name){case"active":Element.isA(element,"assessmentItem")||$itemContainer.removeClass("focus-border");break;case"sleep":$itemContainer.find(".widget-box.edit-active").length||($itemContainer.addClass("focus-border"),styleEditor.setHashClass(sharedStimulusCreator.hashClass));}}}),config.qtiCreatorContext=qtiCreatorContext,creatorRenderer.get(!0,config,areaBroker).setOptions(config.properties).load(function(){var widget;item.setRenderer(this),areaBroker.getItemPanelArea().append(item.render()),Promise.all(item.postRender(_.clone(config.properties))).then(function(){return areaBroker.getContainer().data("widget",item),widget=item.data("widget"),item.attributes.class?styleEditor.setHashClass(item.attributes.class):styleEditor.generateHashClass(),sharedStimulusCreator.hashClass=styleEditor.getHashClass(),widget.$container.find(".qti-itemBody").addClass(sharedStimulusCreator.hashClass),propertiesPanel(areaBroker.getPropertyPanelArea(),widget,config.properties),eventHelper.initElementToWidgetListeners(),pluginRun("render").then(function(){self.trigger("render")})}).catch(function(err){self.trigger("error",err)})},item.getUsedClasses()),this):this.trigger("error",new Error("We need an item to render."))},destroy:function destroy(){var _this3=this;return $(document).off(".qti-widget"),styleEditor.clearCache(),pluginRun("destroy").then(function(){return qtiCreatorContext.destroy()}).then(function(){_this3.trigger("destroy")}).catch(function(err){_this3.trigger("error",err)}),this},getItem:function getItem(){return this.item},getSharedStimulusId:function getSharedStimulusId(){return config.properties.id},getConfig:function getConfig(){return config}}),sharedStimulusCreator}}),define("tpl!taoMediaManager/qtiCreator/component/tpl/sharedStimulusAuthoring",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var helper,options,buffer="",helperMissing=helpers.helperMissing,escapeExpression=this.escapeExpression;return buffer+="<div id=\"item-editor-scope\" data-content-target=\"wide\">\n\n    <nav class=\"action-bar plain content-action-bar horizontal-action-bar\">\n        <ul class=\"menu-left action-group plain item-editor-menu\"></ul>\n\n        <ul class=\"menu action-group plain item-editor-menu\"></ul>\n\n        <ul class=\"menu-right action-group plain item-editor-menu\">\n        </ul>\n    </nav>\n    <div class=\"wrapper clearfix content sidebar-popup-parent\" id=\"item-editor-wrapper\">\n\n        <!-- interaction panel -->\n        <div class=\"item-editor-sidebar-wrapper left-bar\">\n            <form class=\"item-editor-sidebar\" id=\"item-editor-interaction-bar\" autocomplete=\"off\"></form>\n        </div>\n\n        <!-- item panel -->\n        <main id=\"item-editor-panel\" class=\"clearfix\">\n\n            <div class=\"item-editor-bar\">\n                <h1 class=\"truncate\"></h1>\n                <div id=\"toolbar-top\"></div>\n            </div>\n\n            <div id=\"item-editor-scoll-container\">\n                <div id=\"item-editor-scroll-outer\">\n                    <div id=\"item-editor-scroll-inner\">\n                        <!-- item goes here -->\n                    </div>\n                </div>\n            </div>\n\n        </main>\n\n        <!-- properties panel -->\n        <div class=\"item-editor-sidebar-wrapper right-bar sidebar-popup-parent\">\n            <div class=\"item-editor-sidebar\" id=\"item-editor-item-widget-bar\">\n                <div class=\"item-editor-item-related sidebar-right-section-box\" id=\"item-editor-item-property-bar\">\n                    <section class=\"tool-group clearfix\" id=\"sidebar-right-passage-properties\">\n                        <h2>"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Passage Properties",options):helperMissing.call(depth0,"__","Passage Properties",options)))+"</h2>\n                        <div class=\"panel\"></div>\n                    </section>\n                    <section class=\"tool-group clearfix\" id=\"sidebar-right-style-editor\">\n\n                        <h2>"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Passage Style",options):helperMissing.call(depth0,"__","Passage Style",options)))+"</h2>\n\n                        <div class=\"panel color-picker-panel\">\n                            <div class=\"item-editor-color-picker sidebar-popup-container-box\">\n                                <div class=\"color-picker-container sidebar-popup\">\n                                    <div class=\"sidebar-popup-title\">\n                                        <h3 class=\"color-picker-title\"></h3>\n                                        <a class=\"closer\" href=\"#\" data-close=\"#color-picker-container\"></a>\n                                    </div>\n                                    <div class=\"sidebar-popup-content\">\n                                        <div class=\"color-picker\"></div>\n                                        <input class=\"color-picker-input\" type=\"text\" value=\"#000000\">\n                                    </div>\n                                </div>\n                                <div class=\"reset-group\">\n                                    <div class=\"clearfix\">\n                                        <label for=\"initial-bg\" class=\"truncate\">"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Background color",options):helperMissing.call(depth0,"__","Background color",options)))+"</label>\n                                        <button class=\"icon-eraser reset-button\" data-value=\"background-color\"\n                                            aria-label=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Remove custom background color",options):helperMissing.call(depth0,"__","Remove custom background color",options)))+"\"></button>\n                                        <button class=\"color-trigger\" id=\"initial-bg\" data-value=\"background-color\"\n                                            data-target=\"body div.qti-item .hashClass\" data-additional=\"padding:20px\"></button>\n                                    </div>\n                                    <div class=\"clearfix\">\n                                        <label for=\"initial-color\" class=\"truncate\">"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Text color",options):helperMissing.call(depth0,"__","Text color",options)))+"</label>\n                                        <button class=\"icon-eraser reset-button\" data-value=\"color\"\n                                              aria-label=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Remove custom text color",options):helperMissing.call(depth0,"__","Remove custom text color",options)))+"\"></button>\n                                        <button class=\"color-trigger\" id=\"initial-color\" data-value=\"color\"\n                                              data-target=\"body div.qti-item .hashClass\"></button>\n                                    </div>\n                                    <div class=\"clearfix\">\n                                        <label for=\"initial-color\" class=\"truncate\">"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Border color",options):helperMissing.call(depth0,"__","Border color",options)))+"</label>\n                                        <button class=\"icon-eraser reset-button\" data-value=\"color\"\n                                              aria-label=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Remove custom border color",options):helperMissing.call(depth0,"__","Remove custom border color",options)))+"\"></button>\n                                        <button class=\"color-trigger\" id=\"initial-color\" data-value=\"border-color\"\n                                              data-target=\"body div.qti-item .hashClass\" data-additional=\"border-width:4px;border-style:solid;padding:20px\"></button>\n                                    </div>\n                                    <div class=\"clearfix\">\n                                        <label for=\"initial-color\" class=\"truncate\">"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Table headings",options):helperMissing.call(depth0,"__","Table headings",options)))+"</label>\n                                        <button class=\"icon-eraser reset-button\" data-value=\"color\"\n                                              aria-label=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Remove custom background color",options):helperMissing.call(depth0,"__","Remove custom background color",options)))+"\"></button>\n                                        <button class=\"color-trigger\" id=\"initial-color\" data-value=\"background-color\"\n                                              data-target=\"body div.qti-item .hashClass table th\"></button>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                        <hr>\n                        <div class=\"panel\">\n\n                            <div>"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Font family",options):helperMissing.call(depth0,"__","Font family",options)))+"</div>\n\n                            <div class=\"reset-group\">\n                                <select\n                                    data-target=\"body div.qti-item .hashClass\"\n                                    id=\"item-editor-font-selector\"\n                                    data-has-search=\"false\"\n                                    data-placeholder=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Default",options):helperMissing.call(depth0,"__","Default",options)))+"\"\n                                    class=\"select2 has-icon\"\n                                    data-role=\"font-selector\"></select>\n                                <button class=\"icon-eraser reset-button\" data-role=\"font-selector-reset\"\n                                      aria-label=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Remove custom font family",options):helperMissing.call(depth0,"__","Remove custom font family",options)))+"\"></button>\n                            </div>\n\n                        </div>\n                        <div class=\"panel\">\n                            <div>"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Font size",options):helperMissing.call(depth0,"__","Font size",options)))+"</div>\n                            <div class=\"reset-group\">\n                                        <span id=\"item-editor-font-size-changer\" data-target=\"body div.qti-item .hashClass\">\n                                            <button data-action=\"reduce\" aria-label=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Reduce font size",options):helperMissing.call(depth0,"__","Reduce font size",options)))+"\"\n                                               class=\"icon-smaller\"></button>\n                                            <button data-action=\"enlarge\" aria-label=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Enlarge font size",options):helperMissing.call(depth0,"__","Enlarge font size",options)))+"\"\n                                               class=\"icon-larger\"></button>\n                                        </span>\n\n                                <span id=\"item-editor-font-size-manual-input\" class=\"item-editor-unit-input-box\">\n                                            <input type=\"text\" class=\"item-editor-font-size-text has-icon\"\n                                                   placeholder=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"e.g. 13",options):helperMissing.call(depth0,"__","e.g. 13",options)))+"\">\n                                                <span class=\"unit-indicator\">px</span>\n                                        </span>\n                                <button class=\"icon-eraser reset-button\" data-role=\"font-size-reset\"\n                                      aria-label=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Remove custom font size",options):helperMissing.call(depth0,"__","Remove custom font size",options)))+"\"></button>\n                            </div>\n\n                        </div>\n\n                    </section>\n                </div>\n                <div class=\"item-editor-item-related sidebar-right-section-box\" id=\"item-editor-text-property-bar\">\n                    <section class=\"tool-group clearfix\" id=\"sidebar-right-style-editor\">\n\n                        <h2>"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Text Block Style",options):helperMissing.call(depth0,"__","Text Block Style",options)))+"</h2>\n\n                        <div class=\"panel color-picker-panel\">\n                            <div class=\"item-editor-color-picker sidebar-popup-container-box\">\n                                <div class=\"color-picker-container sidebar-popup\">\n                                    <div class=\"sidebar-popup-title\">\n                                        <h3 id=\"color-picker-title\"></h3>\n                                        <a class=\"closer\" href=\"#\" data-close=\"#color-picker-container\"></a>\n                                    </div>\n                                    <div class=\"sidebar-popup-content\">\n                                        <div class=\"color-picker\"></div>\n                                        <input class=\"color-picker-input\" type=\"text\" value=\"#000000\">\n                                    </div>\n                                </div>\n                                <div class=\"reset-group\">\n                                    <div class=\"clearfix\">\n                                        <label for=\"initial-bg\" class=\"truncate\">"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Background color",options):helperMissing.call(depth0,"__","Background color",options)))+"</label>\n                                        <button class=\"icon-eraser reset-button\" data-value=\"background-color\"\n                                              aria-label=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Remove custom background color",options):helperMissing.call(depth0,"__","Remove custom background color",options)))+"\"></button>\n                                        <button class=\"color-trigger\" id=\"initial-bg\" data-value=\"background-color\"\n                                              data-target=\"body div.qti-item .custom-text-box.hashClass\" data-additional=\"padding:20px\"></button>\n                                    </div>\n                                    <div class=\"clearfix\">\n                                        <label for=\"initial-color\" class=\"truncate\">"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Text color",options):helperMissing.call(depth0,"__","Text color",options)))+"</label>\n                                        <button class=\"icon-eraser reset-button\" data-value=\"color\"\n                                              aria-label=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Remove custom text color",options):helperMissing.call(depth0,"__","Remove custom text color",options)))+"\"></button>\n                                        <button class=\"color-trigger\" id=\"initial-color\" data-value=\"color\"\n                                              data-target=\"body div.qti-item .custom-text-box.hashClass\"></button>\n                                    </div>\n                                    <div class=\"clearfix\">\n                                        <label for=\"initial-color\" class=\"truncate\">"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Border color",options):helperMissing.call(depth0,"__","Border color",options)))+"</label>\n                                        <button class=\"icon-eraser reset-button\" data-value=\"color\"\n                                              aria-label=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Remove custom border color",options):helperMissing.call(depth0,"__","Remove custom border color",options)))+"\"></button>\n                                        <button class=\"color-trigger\" id=\"initial-color\" data-value=\"border-color\"\n                                              data-target=\"body div.qti-item .custom-text-box.hashClass\" data-additional=\"border-width:4px;border-style:solid;padding:20px\"></button>\n                                    </div>\n                                    <div class=\"clearfix\">\n                                        <label for=\"initial-color\" class=\"truncate\">"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Table headings",options):helperMissing.call(depth0,"__","Table headings",options)))+"</label>\n                                        <button class=\"icon-eraser reset-button\" data-value=\"color\"\n                                              aria-label=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Remove custom background color",options):helperMissing.call(depth0,"__","Remove custom background color",options)))+"\"></button>\n                                        <button class=\"color-trigger\" id=\"initial-color\" data-value=\"background-color\"\n                                              data-target=\"body div.qti-item .custom-text-box.hashClass table th\"></button>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                        <hr>\n                        <div class=\"panel\">\n\n                            <div>"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Font family",options):helperMissing.call(depth0,"__","Font family",options)))+"</div>\n\n                            <div class=\"reset-group\">\n                                <select\n                                    data-target=\"body div.qti-item .custom-text-box.hashClass\"\n                                    id=\"item-editor-font-selector\"\n                                    data-has-search=\"false\"\n                                    data-placeholder=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Default",options):helperMissing.call(depth0,"__","Default",options)))+"\"\n                                    class=\"select2 has-icon\"\n                                    data-role=\"font-selector\"></select>\n                                <button class=\"icon-eraser reset-button\" data-role=\"font-selector-reset\"\n                                      aria-label=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Remove custom font family",options):helperMissing.call(depth0,"__","Remove custom font family",options)))+"\"></button>\n                            </div>\n\n                        </div>\n                        <div class=\"panel\">\n                            <div>"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Font size",options):helperMissing.call(depth0,"__","Font size",options)))+"</div>\n                            <div class=\"reset-group\">\n                                        <span id=\"item-editor-font-size-changer\" data-target=\"body div.qti-item .custom-text-box.hashClass\">\n                                            <button data-action=\"reduce\" aria-label=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Reduce font size",options):helperMissing.call(depth0,"__","Reduce font size",options)))+"\"\n                                               class=\"icon-smaller\"></button>\n                                            <button data-action=\"enlarge\" aria-label=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Enlarge font size",options):helperMissing.call(depth0,"__","Enlarge font size",options)))+"\"\n                                               class=\"icon-larger\"></button>\n                                        </span>\n\n                                <span id=\"item-editor-font-size-manual-input\" class=\"item-editor-unit-input-box\">\n                                            <input type=\"text\" class=\"item-editor-font-size-text has-icon\"\n                                                   placeholder=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"e.g. 13",options):helperMissing.call(depth0,"__","e.g. 13",options)))+"\">\n                                                <span class=\"unit-indicator\">px</span>\n                                        </span>\n                                <button class=\"icon-eraser reset-button\" data-role=\"font-size-reset\"\n                                      aria-label=\""+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Remove custom font size",options):helperMissing.call(depth0,"__","Remove custom font size",options)))+"\"></button>\n                            </div>\n\n                        </div>\n\n                    </section>\n                    <section class=\"tool-group clearfix\" id=\"sidebar-right-text-block-properties\">\n                        <h2>"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Text Block Properties",options):helperMissing.call(depth0,"__","Text Block Properties",options)))+"</h2>\n\n                        <div class=\"panel\"></div>\n                    </section>\n                </div>\n                <div class=\"item-editor-body-element-related sidebar-right-section-box\" id=\"item-editor-body-element-property-bar\">\n                    <section class=\"tool-group clearfix\" id=\"sidebar-right-body-element-properties\">\n                        <h2><?= __('Element Properties') ?></h2>\n\n                        <div class=\"panel\"></div>\n                    </section>\n                </div>\n            </div>\n        </div>\n        <!-- /properties panel -->\n\n\n    </div>\n\n    <div id=\"mediaManager\"></div>\n    <div id=\"modal-container\"></div>\n</div>",buffer})}),define("taoMediaManager/qtiCreator/component/sharedStimulusAuthoring",["lodash","ui/component","core/pluginLoader","taoMediaManager/qtiCreator/sharedStimulusCreator","taoQtiItem/qtiCreator/editor/areaBroker","tpl!taoMediaManager/qtiCreator/component/tpl/sharedStimulusAuthoring","context","css!taoQtiItemCss/qti-runner.css","css!taoQtiItemCss/themes/default.css","css!taoQtiItemCss/item-creator.css"],function(_,componentFactory,pluginLoaderFactory,sharedStimulusCreatorFactory,areaBrokerFactory,componentTpl,context){'use strict';var defaultPlugins=[{module:"taoQtiItem/qtiCreator/plugins/content/title",bundle:"taoQtiItem/loader/taoQtiItem.min",category:"content"},{module:"taoMediaManager/qtiCreator/plugins/navigation/back",bundle:"taoMediaManager/loader/taoMediaManager.min",category:"menu"},{module:"taoMediaManager/qtiCreator/plugins/menu/save",bundle:"taoMediaManager/loader/taoMediaManager.min",category:"menu"},{module:"taoMediaManager/qtiCreator/plugins/menu/preview",bundle:"taoMediaManager/loader/taoMediaManager.min",category:"menu"},{module:"taoQtiItem/qtiCreator/plugins/content/changeTracker",bundle:"taoQtiItem/loader/taoQtiItem.min",category:"content"},{module:"taoMediaManager/qtiCreator/plugins/content/blockAdder",bundle:"taoMediaManager/loader/taoMediaManager.min",category:"content"}];return function(container){var areaBroker,sharedStimulusCreator,config=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},plugins=Array.isArray(config.plugins)?config.plugins:[];config.plugins=[].concat(defaultPlugins,_toConsumableArray(plugins));var pluginLoader=pluginLoaderFactory(),sharedStimulusAuthoring=componentFactory({getAreaBroker:function getAreaBroker(){return areaBroker}}).setTemplate(componentTpl).on("init",function(){var _this4=this;_.forEach(this.getConfig().plugins,function(plugin){plugin&&plugin.module&&(plugin.exclude?pluginLoader.remove(plugin.module):pluginLoader.add(plugin))}),pluginLoader.load(!!context.bundle).then(function(){return _this4.render(container)}).catch(function(err){return _this4.trigger("error",err)})}).on("render",function(){var $container=this.getElement();areaBroker=areaBrokerFactory($container,{menu:$container.find(".menu"),menuLeft:$container.find(".menu-left"),menuRight:$container.find(".menu-right"),contentCreatorPanel:$container.find("#item-editor-panel"),editorBar:$container.find("#item-editor-panel .item-editor-bar"),title:$container.find("#item-editor-panel .item-editor-bar h1"),toolbar:$container.find("#item-editor-panel .item-editor-bar #toolbar-top"),interactionPanel:$container.find("#item-editor-interaction-bar"),propertyPanel:$container.find("#item-editor-item-widget-bar"),itemPanel:$container.find("#item-editor-scroll-inner"),itemPropertyPanel:$container.find("#sidebar-right-item-properties"),itemStylePanel:$container.find("#item-style-editor-bar"),modalContainer:$container.find("#modal-container"),elementPropertyPanel:$container.find("#item-editor-body-element-property-bar .panel")}),sharedStimulusCreator=sharedStimulusCreatorFactory(this.getConfig(),areaBroker,pluginLoader.getPlugins()).spread(this,"error success ready").on("init",function(){this.render()}).on("destroy",function(){sharedStimulusCreator=null,sharedStimulusAuthoring.destroy()}).init()}).on("destroy",function(){sharedStimulusCreator&&sharedStimulusCreator.destroy(),sharedStimulusCreator=null,areaBroker=null});return _.defer(function(){return sharedStimulusAuthoring.init(config)}),sharedStimulusAuthoring}}),define("taoMediaManager/controller/authoring",["i18n","lodash","jquery","uri","taoMediaManager/qtiCreator/component/sharedStimulusAuthoring","ui/feedback","util/url","core/dataProvider/request","core/logger"],function(__,_,$,uri,sharedStimulusAuthoringFactory,feedback,urlUtil,request,loggerFactory){'use strict';var logger=loggerFactory("taoMediaManager/authoring");return{start:function start(){var $panel=$("#panel-authoring"),assetDataUrl=urlUtil.route("get","SharedStimulus","taoMediaManager"),assetId=uri.decode($panel.attr("data-id")),previewEnabled=!1;request(assetDataUrl,{id:assetId}).then(function(response){response.permissions.includes("READ")&&(previewEnabled=!0)}).then(function(){sharedStimulusAuthoringFactory($panel,{properties:{uri:$panel.attr("data-uri"),id:assetId,assetDataUrl:assetDataUrl,fileUploadUrl:urlUtil.route("upload","ItemContent","taoItems"),fileDeleteUrl:urlUtil.route("delete","ItemContent","taoItems"),fileDownloadUrl:urlUtil.route("download","ItemContent","taoItems"),fileExistsUrl:urlUtil.route("fileExists","ItemContent","taoItems"),getFilesUrl:urlUtil.route("files","ItemContent","taoItems"),baseUrl:urlUtil.route("getFile","MediaManager","taoMediaManager",{uri:""}),path:"taomedia://mediamanager/",root:"mediamanager",lang:"en-US",previewEnabled:previewEnabled,loadCssUrl:urlUtil.route("load","SharedStimulusStyling","taoMediaManager"),saveCssUrl:urlUtil.route("save","SharedStimulusStyling","taoMediaManager")}}).on("success",function(){feedback().success(__("Your passage is saved"))}).on("error",function(err){_.isUndefined(err.message)||feedback().error(err.message),logger.error(err)})})}}}),define("taoMediaManager/previewer/component/qtiSharedStimulusItem",["context","taoQtiTestPreviewer/previewer/runner","css!taoQtiTestPreviewer/previewer/provider/item/css/item"],function(context,previewerFactory){'use strict';return function(container){var config=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},template=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,testRunnerConfig={testDefinition:"test-container",serviceCallId:"previewer",providers:{runner:{id:"qtiItemPreviewer",module:"taoQtiTestPreviewer/previewer/provider/item/item",bundle:"taoQtiTestPreviewer/loader/qtiPreviewer.min",category:"runner"},proxy:{id:"qtiSharedStimulusItemProxy",module:"taoMediaManager/previewer/proxy/qtiSharedStimulusItem",bundle:"taoMediaManager/loader/taoMediaManager.min",category:"proxy"},communicator:{id:"request",module:"core/communicator/request",bundle:"loader/vendor.min",category:"communicator"},plugins:config.plugins||[]},options:{view:config.view,readOnly:config.readOnly,fullPage:config.fullPage,plugins:config.pluginsOptions,hideActionBars:config.hideActionBars},proxyProvider:"qtiSharedStimulusItemProxy"};return testRunnerConfig.loadFromBundle=!!context.bundle,previewerFactory(container,testRunnerConfig,template).on("ready",function(runner){var _this5=this;if(runner.on("renderitem",function(){config.itemState&&runner.itemRunner.setState(config.itemState),_this5.trigger("preview-loaded")}),config.itemUri)return runner.loadItem(config.itemUri)})}}),define("taoMediaManager/controller/editInstance",["jquery","lodash","layout/actions/binder","ui/previewer","util/url","taoMediaManager/previewer/component/qtiSharedStimulusItem","core/logger","ui/feedback","layout/loading-bar"],function($,_,binder,previewer,urlUtil,qtiItemPreviewerFactory,loggerFactory,feedback,loadingBar){'use strict';var logger=loggerFactory("taoMediaManager/editInstance");return{start:function start(){var $previewer=$(".previewer"),file={};file.url=$previewer.data("url"),file.mime=$previewer.data("type");var isPreviewEnabled=$previewer.data("enabled"),isPassage="application/qti+xml"===file.mime;isPreviewEnabled&&(isPassage?(loadingBar.start(),qtiItemPreviewerFactory($previewer,{itemUri:$("#edit-media").data("uri")}).on("error",function(err){_.isUndefined(err.message)||feedback().error(err.message),logger.error(err)}).on("preview-loaded",loadingBar.stop)):(file.containerClass="no-background",$previewer.previewer(file))),isPassage?$("#media-authoring").show():$("#media-authoring").hide(),$("#edit-media").off().on("click",function(){var action={binding:"load",url:urlUtil.route("editMedia","MediaImport","taoMediaManager")};binder.exec(action,{classUri:this.dataset.classuri,id:this.dataset.uri}||this._resourceContext)})}}}),define("taoMediaManager/controller/routes",[],function(){'use strict';return{MediaManager:{deps:"controller/actions",actions:{editInstance:"controller/editInstance",authoring:"controller/authoring"}}}}),define("taoMediaManager/previewer/adapter/item/qtiSharedStimulusItem",["lodash","core/logger","taoMediaManager/previewer/component/qtiSharedStimulusItem","ui/feedback"],function(_,loggerFactory,qtiItemPreviewerFactory,feedback){'use strict';var logger=loggerFactory("taoMediaManager/previewer"),defaultPlugins=[{module:"taoQtiTestPreviewer/previewer/plugins/controls/close",bundle:"taoQtiTestPreviewer/loader/qtiPreviewer.min",category:"controls"},{module:"taoQtiTestPreviewer/previewer/plugins/tools/scale/scale",bundle:"taoQtiTestPreviewer/loader/qtiPreviewer.min",category:"tools"},{module:"taoQtiTest/runner/plugins/tools/itemThemeSwitcher/itemThemeSwitcher",bundle:"taoQtiTest/loader/testPlugins.min",category:"tools"}];return{name:"qtiSharedStimulusItem",init:function init(sharedStimulusId){var config=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return config.itemUri=sharedStimulusId,config.plugins=Array.isArray(config.plugins)?[].concat(defaultPlugins,_toConsumableArray(config.plugins)):defaultPlugins,qtiItemPreviewerFactory(window.document.body,config).on("error",function(err){_.isUndefined(err.message)||feedback().error(err.message),logger.error(err)})}}}),define("taoMediaManager/previewer/proxy/qtiSharedStimulusItem",["jquery","lodash","i18n","core/promiseQueue","core/dataProvider/request","util/url","taoMediaManager/qtiCreator/helper/createDummyItemData"],function($,_,__,promiseQueue,request,urlUtil,creatorDummyItemData){'use strict';var serviceExtension="taoMediaManager";return{name:"qtiSharedStimulusItemProxy",install:function(){this.queue=promiseQueue()},init:function(){return Promise.resolve({})},destroy:function(){return this.queue=null,Promise.resolve()},getItem:function(identifier){return Promise.all([request(urlUtil.route("get","SharedStimulus",serviceExtension),{id:identifier},"GET"),request(urlUtil.route("getStylesheets","SharedStimulusStyling",serviceExtension),{uri:identifier})]).then(function(_ref){var _ref2=_slicedToArray(_ref,2),data=_ref2[0],styles=_ref2[1],itemData=creatorDummyItemData(data);return data.baseUrl=urlUtil.route("getFile","MediaManager","taoMediaManager",{uri:""}),data.content={type:"qti",data:itemData},styles.forEach(function(stylesheet,index){var serial="stylesheet_".concat(index);data.content.data.stylesheets[serial]={qtiClass:"stylesheet",attributes:{href:urlUtil.route("loadStylesheet","SharedStimulusStyling","taoMediaManager",{uri:identifier,stylesheet:stylesheet}),media:"all",title:"",type:"text/css"},serial:serial,getComposingElements:function getComposingElements(){return{}}}}),data})}}}),define("taoMediaManager/qtiCreator/widgets/helpers/content",["jquery","lodash","taoMediaManager/qtiCreator/helper/creatorRenderer","taoQtiItem/qtiCreator/model/helper/container","taoQtiItem/qtiCreator/editor/gridEditor/content"],function($,_,creatorRenderer,containerHelper,gridContentHelper){'use strict';return{createElements:function(container,$container,data,callback){var $dummy=$("<div>").html(data);containerHelper.createElements(container,gridContentHelper.getContent($dummy),function(newElts){creatorRenderer.get().load(function(){_.each(newElts,function(serial){var $placeholder,$widget,widget;$placeholder=$container.find(".widget-box[data-new][data-qti-class=".concat(serial.qtiClass,"]")),serial.setRenderer(this),serial.render($placeholder),serial.postRender(),widget=serial.data("widget"),$widget=widget.$original,$widget.trigger("contentChange.gridEdit"),_.isFunction(callback)&&callback(widget)}.bind(this))},this.getUsedClasses())})},changeInnerWidgetState:function(outerWidget,state){var selector=[];_.forEach(["img","math","object","include"],function(qtiClass){selector.push("[data-html-editable] .widget-".concat(qtiClass))}),outerWidget.$container.find(selector.join(",")).each(function(){var innerWidget=$(this).data("widget");innerWidget&&innerWidget.changeState(state)})}}}),define("taoMediaManager/qtiCreator/widgets/states/Active",["jquery","taoQtiItem/qtiCreator/widgets/states/factory","taoMediaManager/qtiCreator/widgets/helpers/content"],function($,stateFactory,contentHelper){'use strict';return stateFactory.create("active",function(){function checkIfWidgetShouldSleep(e){return container!==e.target&&!$.contains(container,e.target)&&$.contains(outerContainer,e.target)&&(!areaBroker||!areaBroker.getEditorBarArea||!$.contains(areaBroker.getEditorBarArea().get(0),e.target))&&(!$modalFeedbacksArea.length||!$.contains($modalFeedbacksArea[0],e.target))&&"restore"!==$(e.target).data("role")&&!$(e.target).closest(".widget-popup").length}var _widget=this.widget,container=_widget.$container[0],item=_widget.element.getRootElement(),areaBroker=_widget.getAreaBroker(),$modalFeedbacksArea=$("#modalFeedbacks"),outerContainer=document.querySelector("#item-editor-scroll-outer");areaBroker.getContentCreatorPanelArea().on("mousedown.active.".concat(_widget.serial),function(e){checkIfWidgetShouldSleep(e)&&_widget.changeState("sleep")}).on("beforesave.qti-creator.active",function(){_widget.changeState("sleep")}).on("styleedit.active",function(){_widget.changeState("sleep")}),$(document).on("open-preview.qti-item",function(){_widget.changeState("sleep")}),item&&item.data("widget")&&item.data("widget").$container.on("resizestart.gridEdit.active beforedragoverstart.gridEdit.active",function(){_widget.changeState("sleep")})},function(){var areaBroker=this.widget.getAreaBroker();contentHelper.changeInnerWidgetState(this.widget,"sleep"),this.widget.$container.off(".active"),areaBroker.getContentCreatorPanelArea().off(".active.".concat(this.widget.serial));var item=this.widget.element.getRootElement();item&&item.data("widget")&&item.data("widget").$container.off(".active")})}),define("taoMediaManager/qtiCreator/widgets/static/states/Active",["jquery","taoQtiItem/qtiCreator/widgets/states/factory","taoMediaManager/qtiCreator/widgets/states/Active"],function($,stateFactory,Active){'use strict';return stateFactory.extend(Active,function(){var _widget=this.widget,$container=_widget.$container;_widget.beforeStateInit(function(e,element,state){var composingElts,serial=element.getSerial();("active"===state.name&&serial!==_widget.serial||"choice"===state.name)&&("rubricBlock"===_widget.element.qtiClass?(composingElts=_widget.element.getComposingElements(),!composingElts[element.serial]&&_widget.changeState("sleep")):_widget.changeState("sleep"))},"otherActive"),$container.on("mouseenter.active",function(e){e.stopPropagation(),$container.parent().trigger("mouseleave.sleep")}).on("mouseleave.active",function(e){e.stopPropagation(),$container.parent().trigger("mouseenter.sleep")}).on("click.active",function(e){e.stopPropagation()})},function(){var _widget=this.widget,areaBroker=_widget.getAreaBroker();_widget.$container.off(".active"),areaBroker.getContentCreatorPanelArea().off(".active.".concat(_widget.serial)),_widget.offEvents("otherActive")})}),define("taoMediaManager/qtiCreator/helper/ckConfigurator",["lodash","ui/ckeditor/ckConfigurator","mathJax"],function(_,ckConfigurator,mathJax){'use strict';var _defaults={qtiImage:!0,qtiMedia:!0,qtiInclude:!1,underline:!0,mathJax:!!mathJax,removePlugins:"taoqtiinclude"};return{getConfig:function getConfig(editor){var toolbarType=1<arguments.length&&arguments[1]!==void 0?arguments[1]:"qtiInline",options=2<arguments.length?arguments[2]:void 0;return ckConfigurator.getConfig(editor,toolbarType,_.defaults(options||{},_defaults))}}}),define("taoMediaManager/qtiCreator/editor/ckEditor/htmlEditor",["lodash","i18n","jquery","ckeditor","core/promise","taoMediaManager/qtiCreator/helper/ckConfigurator","taoQtiItem/qtiItem/core/Element","taoMediaManager/qtiCreator/widgets/helpers/content","taoQtiItem/qtiCreator/widgets/helpers/deletingState","taoQtiItem/qtiCreator/editor/ckEditor/featureFlag"],function(_,__,$,CKEditor,Promise,ckConfigurator,Element,contentHelper,deletingHelper,featureFlag){'use strict';function _buildEditor($editable,$editableContainer,options){var widget=(options.data||{}).widget,areaBroker=widget&&widget.getAreaBroker&&widget.getAreaBroker(),$toolbarArea=areaBroker&&areaBroker.getToolbarArea&&areaBroker.getToolbarArea();if(options=_.defaults(options,_defaults),!($editable instanceof $)||!$editable.length)throw new Error("invalid jquery element for $editable");if(!($editableContainer instanceof $)||!$editableContainer.length)throw new Error("invalid jquery element for $editableContainer");options.placeholder&&""!==options.placeholder&&($editable.is("input")?$editable.attr("placeholder",options.placeholder):$editable.attr("data-placeholder",options.placeholder));var ckConfig={dtdMode:"qti",autoParagraph:!1,removePlugins:options.removePlugins||"",enterMode:options.enterMode||CKEditor.ENTER_P,floatSpaceDockedOffsetY:10,sharedSpaces:{top:$toolbarArea&&$toolbarArea.attr("id")||"toolbar-top"},taoQtiItem:{insert:function insert(tempWidget){var $newContent=$(tempWidget).clone();if(options.data&&options.data.container&&options.data.widget){var $newImgPlaceholder=$editable.find("[data-new=\"true\"][data-qti-class=\"img\"]");$newImgPlaceholder.length&&!$editable.closest(".qti-simpleChoice").length&&($newImgPlaceholder.attr("data-qti-class","figure"),$("<span>&nbsp;</span>").insertAfter($newImgPlaceholder)),contentHelper.createElements(options.data.container,$editable,_htmlEncode(this.getData()),function(createdWidget){var createdElement=createdWidget.element;_.isFunction(createdElement.initContainer)&&(createdElement.body($newContent.html()),createdWidget.rebuild(),createdWidget=createdElement.data("widget")),_activateInnerWidget(options.data.widget,createdWidget)})}}},on:{instanceReady:function instanceReady(e){var widgets={},editor=e.editor;$editable.data("editor",editor),$editable.data("editor-options",options),editor.on("change",_.debounce(function(){_detectWidgetDeletion($editable,widgets,editor),_.isFunction(options.change)&&options.change.call(editor,_htmlEncode(editor.getData()))},100,{leading:!0})),managePlaceholder($editable,editor),options.data&&options.data.container&&($editable.data("qti-container",options.data.container),widgets=_rebuildWidgets(options.data.container,$editable,{restoreState:!0}),options.shieldInnerContent&&_shieldInnerContent($editable,options.data.widget)),options.autofocus&&_focus(editor),$editable.trigger("editorready",[editor]),$(".qti-item").trigger("toolbarchange")},blur:function blur(){$toolbarArea&&$toolbarArea.hide()},focus:function focus(){$toolbarArea&&$toolbarArea.show(),_.isFunction(options.focus)&&options.focus.call(this,_htmlEncode(this.getData())),$editable.trigger("editorfocus"),$(".qti-item").trigger("toolbarchange")},configLoaded:function configLoaded(e){var toolbarType=options.toolbarType||"";options.toolbar&&_.isArray(options.toolbar)?ckConfig.toolbar=options.toolbar:toolbarType=getTooltypeFromContainer($editableContainer),"undefined"!=typeof options.qtiMedia&&(ckConfig.qtiMedia=options.qtiMedia),"undefined"!=typeof options.qtiImage&&(ckConfig.qtiImage=options.qtiImage),"undefined"!=typeof options.qtiInclude&&(ckConfig.qtiInclude=options.qtiInclude),"undefined"!=typeof options.highlight&&(ckConfig.highlight=options.highlight),e.editor.config=ckConfigurator.getConfig(e.editor,toolbarType,ckConfig)},afterPaste:function afterPaste(){}}};return CKEditor.inline($editable[0],ckConfig)}function managePlaceholder($editable,editor){$editable.is("input")||(togglePlaceholder($editable),editor.on("change",function(){togglePlaceholder($editable)}))}function togglePlaceholder($editable){""!==$editable.text().trim()||$editable.find(["img","table","math","object","printedVariable",".tooltip-target"].join(",")).length?removePlaceholder($editable):$editable.addClass("cke-placeholder")}function removePlaceholder($editable){$editable.removeClass("cke-placeholder")}function getTooltypeFromContainer($editableContainer){var toolbarType="qtiFlow";return $editableContainer.hasClass("widget-blockInteraction")||$editableContainer.hasClass("widget-textBlock")||$editableContainer.hasClass("widget-rubricBlock")?toolbarType="qtiBlock":$editableContainer.hasClass("qti-prompt-container")||$editableContainer.hasClass("widget-hottext")?toolbarType="qtiInline":$editableContainer.hasClass("widget-table")&&!featureFlag.disableCellAlignment&&(toolbarType="qtiTable"),toolbarType}function _find($container,dataAttribute){var $collection;return $collection=$container.data(dataAttribute)?$container:$container.find("[data-".concat(dataAttribute,"=true]")),$collection}function _rebuildWidgets(container,$container,options){var widgets={};return options=options||{},_.each(_.values(container.elements),function(elt){var widget=elt.data("widget"),currentState=widget.getCurrentState().name;widgets[elt.serial]=widget.rebuild({context:$container,ready:function ready(widgetInner){options.restoreState&&widgetInner.changeState(currentState)}})}),$container.trigger("widgetCreated",[widgets,container]),widgets}function _findWidgetContainer($container,serial){return $($container.selector).find(".widget-box[data-serial=".concat(serial,"]"))}function _detectWidgetDeletion($container,widgets,editor){var deleted=[],container=$container.data("qti-container");if(_.each(widgets,function(w){if(!w.element.data("removed")){var $widget=_findWidgetContainer($container,w.serial);$widget.length||deleted.push(w)}}),deleted.length){var undoCmd=editor.getCommand("undo"),$messageBox=deletingHelper.createInfoBox(deleted);$messageBox.on("confirm.deleting",function(){_.each(deleted,function(w){w.element.remove(),w.destroy()}),editor.resetUndo()}).on("undo.deleting",function(){editor.undoManager.undo(),_rebuildWidgets(container,$container,{restoreState:!0}),_shieldInnerContent($container,container.data("widget"))}),undoCmd&&undoCmd.on("afterUndo",function(){$messageBox.find("a.undo").click()})}}function addShield($widget){var $shield=$("<button>",{class:"html-editable-shield"});return $widget.attr("contenteditable",!1),$widget.append($shield),$shield}function _shieldInnerContent($container,containerWidget){$container.find(".widget-box").each(function(){var $widget=$(this);addShield($widget).on("click",function(e){e.stopPropagation();var innerWidget=$widget.data("widget");_activateInnerWidget(containerWidget,innerWidget)})})}function _activateInnerWidget(containerWidget,innerWidget){var listenToWidgetCreation,event="widgetCreated.".concat(innerWidget.serial);containerWidget&&containerWidget.element&&containerWidget.element.qtiClass?(listenToWidgetCreation=function(){containerWidget.$container.on(event,function(e,widgets){var targetWidget=widgets[innerWidget.serial];targetWidget&&(containerWidget.$container.off(event),_.delay(function(){Element.isA(targetWidget.element,"interaction")?targetWidget.changeState("question"):targetWidget.changeState("active")},100))})},Element.isA(containerWidget.element,"_container")&&!containerWidget.element.data("stateless")?(listenToWidgetCreation(),containerWidget.changeState("sleep")):Element.isA(containerWidget.element,"interaction")?(listenToWidgetCreation(),containerWidget.changeState("sleep")):Element.isA(containerWidget.element,"choice")?(listenToWidgetCreation(),containerWidget.changeState("question")):Element.isA(containerWidget.element,"table")?(listenToWidgetCreation(),containerWidget.changeState("sleep")):Element.isA(innerWidget.element,"choice")?innerWidget.changeState("choice"):innerWidget.changeState("active")):innerWidget.changeState("active")}function _htmlEncode(encodedStr){return encodedStr}function _focus(editor){if(editor.editable()&&editor.editable().$.parentNode){editor.focus();var range=editor.createRange();range.moveToElementEditablePosition(editor.editable(),!0),editor.getSelection().selectRanges([range])}}var editorFactory,_defaults={placeholder:__("some text ..."),shieldInnerContent:!0,passthroughInnerContent:!1,autofocus:!0};return CKEditor.disableAutoInline=!0,editorFactory={hasEditor:function($container){var hasEditor=!1;return _find($container,"html-editable").each(function(){return hasEditor=!!$(this).data("editor"),hasEditor}),hasEditor},buildEditor:function buildEditor($container,editorOptions){var buildTasks=[];return _find($container,"html-editable-container").each(function(){var $editableContainer=$(this),$editable=$editableContainer.find("[data-html-editable]");buildTasks.push(new Promise(function(resolve){$editable.attr("contenteditable",!0),_buildEditor($editable,$editableContainer,editorOptions),$editable.on("editorready",resolve)}))}),Promise.all(buildTasks)},destroyEditor:function destroyEditor($container){var destructTasks=[];return _find($container,"html-editable-container").each(function(){var $editableContainer=$(this),$editable=$editableContainer.find("[data-html-editable]");$editable.removeAttr("contenteditable"),$editable.data("editor")&&destructTasks.push(new Promise(function(resolve){var editor=$editable.data("editor"),options=$editable.data("editor-options");_.isFunction(options.change)&&options.change.call(editor,_htmlEncode(editor.getData())),removePlaceholder($editable),editor.on("destroy",function(){$editable.removeData("editor").removeData("editor-options"),$editable.data("qti-container")&&_rebuildWidgets($editable.data("qti-container"),$editable),$editable.trigger("editordestroyed"),resolve()}),editor.focusManager.blur(!0),editor.destroy()}))}),Promise.all(destructTasks)},getData:function getData($editable){var editor=$editable.data("editor");if(editor)return _htmlEncode(editor.getData());throw new Error("no editor attached to the DOM element")},setData:function setData($editable,data){var editor=$editable.data("editor");if(editor)_.isString(data)&&editor.setData(_.escape(data));else throw new Error("no editor attached to the DOM element")},focus:function focus($editable){_find($editable,"html-editable").each(function(){var editor=$(this).data("editor");editor&&_focus(editor)})}},editorFactory}),define("tpl!taoMediaManager/qtiCreator/tpl/forms/static/text",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var stack1,helper,options,buffer="",helperMissing=helpers.helperMissing,escapeExpression=this.escapeExpression;return buffer+="<div class=\"panel\">\n    <label for=\"textBlockCssClass\">"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Text Block CSS Class",options):helperMissing.call(depth0,"__","Text Block CSS Class",options)))+"</label>\n    <span class=\"icon-help tooltipstered\" data-tooltip=\"~ .tooltip-content:first\" data-tooltip-theme=\"info\"></span>\n    <div class=\"tooltip-content\">"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Set a CSS class name in order to customize the display style.",options):helperMissing.call(depth0,"__","Set a CSS class name in order to customize the display style.",options)))+"</div>\n    <input type=\"text\" name=\"textBlockCssClass\" value=\"",(helper=helpers.textBlockCssClass)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.textBlockCssClass,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\" />\n</div>",buffer})}),define("taoMediaManager/qtiCreator/widgets/static/text/states/Active",["jquery","taoQtiItem/qtiCreator/widgets/states/factory","taoMediaManager/qtiCreator/widgets/static/states/Active","taoMediaManager/qtiCreator/editor/ckEditor/htmlEditor","taoQtiItem/qtiCreator/editor/gridEditor/content","taoQtiItem/qtiCreator/widgets/helpers/formElement","tpl!taoMediaManager/qtiCreator/tpl/forms/static/text","taoMediaManager/qtiCreator/editor/styleEditor/styleEditor","taoMediaManager/qtiCreator/editor/styleEditor/fontSelector","taoMediaManager/qtiCreator/editor/styleEditor/colorSelector","taoMediaManager/qtiCreator/editor/styleEditor/fontSizeChanger"],function($,stateFactory,Active,htmlEditor,content,formElement,formTpl,styleEditor,fontSelector,colorSelector,fontSizeChanger){'use strict';var TextActive=stateFactory.extend(Active,function(){this.buildStylesEditor(),this.buildEditor(),this.initForm()},function(){this.destroyEditor(),this.destroyStylesEditor(),this.widget.$form.empty()});return TextActive.prototype.buildEditor=function(){var widget=this.widget,$editableContainer=widget.$container,container=widget.element,changeCallback=content.getChangeCallback(container);$editableContainer.attr("data-html-editable-container",!0),htmlEditor.hasEditor($editableContainer)||htmlEditor.buildEditor($editableContainer,{change:function change(data){changeCallback.call(this,data),data||widget.$form.find("[name=\"textBlockCssClass\"]").val("")},blur:function blur(){widget.changeState("sleep")},data:{widget:widget,container:container}})},TextActive.prototype.buildStylesEditor=function(){var widget=this.widget,$editableContainer=widget.$container,$block=$editableContainer.find(".".concat("custom-text-box"));if(!$block.length){$block=widget.$container.find("[data-html-editable=\"true\"]").wrapInner("<div />").children();var hashClass=styleEditor.generateHashClass();$block.attr("class","".concat("custom-text-box"," ").concat(hashClass))}else{var blockCls=widget.$container.find(".".concat("custom-text-box")).attr("class").split(" "),_hashClass=blockCls.find(function(className){return /^tao-*/.test(className)});_hashClass?styleEditor.setHashClass(_hashClass):(_hashClass=styleEditor.generateHashClass(),$block.addClass(_hashClass))}var $textEditor=$("#item-editor-text-property-bar");fontSelector($textEditor),colorSelector($textEditor),fontSizeChanger($textEditor)},TextActive.prototype.destroyEditor=function(){htmlEditor.destroyEditor(this.widget.$container)},TextActive.prototype.destroyStylesEditor=function(){var hashClass=styleEditor.getHashClass(),$block=this.widget.$container.find(".".concat("custom-text-box")),textBlockCssClass=($block.attr("class")||"").replace("custom-text-box","").replace(hashClass,"").trim(),styles=styleEditor.getStyle(),regex=new RegExp(hashClass);textBlockCssClass||Object.keys(styles).find(function(selector){return regex.test(selector)})||$block.children().unwrap()},TextActive.prototype.initForm=function(){var widget=this.widget,$form=widget.$form,blockCls=widget.$container.find(".".concat("custom-text-box")).attr("class"),hashClass=styleEditor.getHashClass();$form.html(formTpl({textBlockCssClass:(blockCls||"").replace("custom-text-box","").replace(hashClass,"").trim()})),formElement.initWidget($form),formElement.setChangeCallbacks($form,widget.element,{textBlockCssClass:function textBlockCssClass(element,value){var $block=widget.$container.find(".".concat("custom-text-box"));value=value.trim(),"custom-text-box"===value&&(value=""),value&&(!$block.length&&($block=widget.$container.find("[data-html-editable=\"true\"]").wrapInner("<div />").children()),$block.attr("class","".concat("custom-text-box"," ").concat(value)))}})},TextActive}),define("taoMediaManager/qtiCreator/widgets/static/text/states/states",["taoQtiItem/qtiCreator/widgets/states/factory","taoQtiItem/qtiCreator/widgets/static/states/states","taoQtiItem/qtiCreator/widgets/static/text/states/Sleep","taoMediaManager/qtiCreator/widgets/static/text/states/Active"],function(factory,states){'use strict';return factory.createBundle(states,arguments)}),define("taoMediaManager/qtiCreator/widgets/static/text/Widget",["jquery","taoQtiItem/qtiCreator/widgets/static/Widget","taoMediaManager/qtiCreator/widgets/static/text/states/states","tpl!taoQtiItem/qtiCreator/tpl/toolbars/textBlock"],function($,Widget,states,toolbarTpl){'use strict';var TextWidget=Widget.clone();return TextWidget.initCreator=function(){Widget.initCreator.call(this),this.registerStates(states)},TextWidget.buildContainer=function(){var $wrap=$("<div>",{"data-serial":this.element.serial,"data-qti-class":"_container",class:"widget-box widget-block widget-textBlock"}).append($("<div>",{"data-html-editable":!0}));this.$original.wrapInner($wrap),this.$container=this.$original.children(".widget-box")},TextWidget.createToolbar=function(){var _this6=this,$tlb=$(toolbarTpl({serial:this.serial,state:"active"}));return this.$container.append($tlb),$tlb.find("[data-role=\"delete\"]").on("click.widget-box",function(e){e.stopPropagation(),_this6.changeState("deleting")}),this},TextWidget}),define("taoMediaManager/qtiCreator/editor/blockAdder/blockAdder",["jquery","lodash","tpl!taoQtiItem/qtiCreator/editor/blockAdder/tpl/addColumnRow","taoQtiItem/qtiItem/core/Element","taoMediaManager/qtiCreator/helper/creatorRenderer","taoQtiItem/qtiCreator/model/helper/container","taoQtiItem/qtiCreator/editor/gridEditor/content","taoMediaManager/qtiCreator/widgets/static/text/Widget"],function($,_,adderTpl,Element,creatorRenderer,containerHelper,contentHelper,TextWidget){'use strict';function _insertElement(qtiClass,$placeholder){$placeholder.removeAttr("id"),$placeholder.addClass("widget-box"),$placeholder.attr({"data-new":!0,"data-qti-class":qtiClass});var $widget=$placeholder.parent().closest(".widget-box, .qti-item"),$editable=$placeholder.closest("[data-html-editable], .qti-itemBody"),widget=$widget.data("widget"),element=widget.element,container=Element.isA(element,"_container")?element:element.getBody();if(!element||!$editable.length)throw new Error("cannot create new element");containerHelper.createElements(container,contentHelper.getContent($editable),function(newElts){var creator=creatorRenderer.get();creator.load(function(){for(var serial in newElts){var elt=newElts[serial],$widgetElem=void 0,widgetElem=void 0,$colParent=$placeholder.parent();elt.setRenderer(this),$placeholder.replaceWith("<div class=\"text-block\"></div>");var $textBlock=$colParent.find(".text-block");$textBlock.html(elt.render()),widgetElem=TextWidget.build(elt,$textBlock,creator.getOption("textOptionForm"),{ready:function ready(){this.$container.parent(".text-block").length&&this.$container.unwrap(),this.changeState("active")}}),$widgetElem=widgetElem.$container,$widgetElem.trigger("contentChange.gridEdit"),$widgetElem.trigger("resize.gridEdit")}},this.getUsedClasses())})}return{create:function(item,$editorPanel){function _getItemBody(){return $editorPanel.find(".qti-itemBody")}function _initInsertion($widget){var $wrap=$("<div class=\"colrow\"></div>"),$colRow=$widget.parent(".colrow");$editorPanel.trigger("beforesave.qti-creator.active"),$colRow.length||($widget.wrap("<div class=\"colrow\"></div>"),$colRow=$widget.parent(".colrow")),$colRow.after($wrap);var $placeholder=$("<div class=\"placeholder\">");$wrap.addClass("tmp").prepend($placeholder),_insertElement("_container",$placeholder)}function _endInsertion(){item.body(contentHelper.getContent(_getItemBody()))}function _done($wrap){$wrap.removeClass("tmp"),_endInsertion()}function _appendButton($widget){if(!$widget.children(".add-block-element").length&&!$widget.parent(".colrow.tmp").length){var $adder=$(adderTpl());$widget.append($adder),$adder.on("click",function(e){e.preventDefault(),e.stopPropagation();var $widgetParent=$(this).parents(".widget-box");_initInsertion($widgetParent)})}}$editorPanel.find(".widget-textBlock").each(function(){_appendButton($(this))}),$editorPanel.on("ready.qti-widget",function(e,_widget){var qtiElement=_widget.element;if(qtiElement.is("_container")){var $colRow=_widget.$container.parent(".colrow");$colRow.hasClass("tmp")&&_done($colRow),$colRow.length||_widget.$container.wrap("<div class=\"colrow\"></div>"),_appendButton(_widget.$container)}})}}}),define("taoMediaManager/qtiCreator/editor/containerEditor",["lodash","jquery","core/promise","taoQtiItem/qtiItem/core/Loader","taoQtiItem/qtiCreator/model/Container","taoQtiItem/qtiCreator/model/Item","taoQtiItem/qtiCreator/model/helper/event","taoQtiItem/qtiCreator/model/qtiClasses","taoQtiItem/qtiCreator/helper/commonRenderer","taoQtiItem/qtiCreator/helper/xmlRenderer","taoQtiItem/qtiItem/helper/simpleParser","taoMediaManager/qtiCreator/helper/creatorRenderer","taoQtiItem/qtiCreator/editor/gridEditor/content","taoQtiItem/qtiCreator/editor/ckEditor/htmlEditor"],function(_,$,Promise,Loader,Container,Item,event,allQtiClasses,commonRenderer,xmlRenderer,simpleParser,creatorRenderer,content,htmlEditor){'use strict';function parser($container){var data=simpleParser.parse($container.clone(),{ns:{math:"m"}});if(data.body)return data.body;throw new Error("invalid content for qti container")}function buildContainer($container){$container.wrapInner($("<div>",{class:"container-editor","data-html-editable":!0}))}function cleanup($container){var container=$container.data("container");return new Promise(function(resolve){container?($(document).off(".".concat(container.serial)),commonRenderer.load(["img","object","math","include","_container","printedVariable","_tooltip"],function(){$container.html(container.render(this)),resolve()}),$container.removeData("container")):resolve()})}function createFakeWidget($editableContainer,container,options){var widget={$container:$editableContainer,element:container,changeState:_.noop,getAreaBroker:function(){return options.areaBroker}};return container.data("widget",widget),widget}function buildEditor($editableContainer,container,options){$editableContainer.attr("data-html-editable-container",!0),htmlEditor.hasEditor($editableContainer)||htmlEditor.buildEditor($editableContainer,_.defaults(options||{},{shieldInnerContent:!1,passthroughInnerContent:!1,change:content.getChangeCallback(container),data:{widget:createFakeWidget($editableContainer,container,options),container:container}}))}function extractHtmlFromMarkup(markupStr,selector){var $found=$("<div>").html(markupStr).find(selector),ret=[];return $found.each(function(){ret.push($(this).html())}),ret}var _defaults={change:_.noop,markup:"",markupSelector:"",qtiMedia:!1};return event.initElementToWidgetListeners(),{create:function($container,options){var html,htmls,data,loader;options=_.defaults(options||{},_defaults),options.markup&&(html=options.markup,options.markupSelector&&(htmls=extractHtmlFromMarkup(html,options.markupSelector),html=htmls[0]||""),$container.html(html)),data=parser($container),loader=new Loader().setClassesLocation(allQtiClasses),loader.loadRequiredClasses(data,function(){var item,containerEditors,renderer,container=new Container;container.data("stateless",!0),$container.data("container",container),item=new Item().setElement(container),container.setRootElement(item),options.metadata&&_.each(options.metadata,function(value,name){item.data(name,value)}),options.related&&(containerEditors=options.related.data("container-editors")||[],containerEditors.push(container),options.related.data("container-editors",containerEditors)),this.loadContainer(container,data),renderer=creatorRenderer.get(options.resetRenderer,{},options.areaBroker),renderer.load(function(){container.setRenderer(this),$container.html(container.render()),container.postRender(),buildContainer($container),buildEditor($container,container,{placeholder:options.placeholder||"",toolbar:options.toolbar||"",qtiMedia:options.qtiMedia,highlight:options.highlight,removePlugins:options.removePlugins||"",areaBroker:options.areaBroker,autofocus:options.autofocus||!1}),$container.off(".".concat("containereditor")).on(event.getList("containereditor"+event.getNs()+event.getNsModel()).join(" "),_.throttle(function(){var editorContent=container.render(xmlRenderer.get());$container.trigger("containerchange.".concat("containereditor"),[editorContent]),_.isFunction(options.change)&&options.change(editorContent)},600)),$container.trigger("editorready.containereditor")},["img","object","math","include","printedVariable","_container","_tooltip"])})},destroy:function($editableContainer){return htmlEditor.destroyEditor($editableContainer).then(function(){return $editableContainer.removeAttr("data-html-editable-container"),cleanup($editableContainer)})}}}),define("taoMediaManager/qtiCreator/plugins/content/blockAdder",["i18n","core/plugin","taoMediaManager/qtiCreator/editor/blockAdder/blockAdder"],function(__,pluginFactory,blockAdder){'use strict';return pluginFactory({name:"blockAdder",init:function(){},render:function(){blockAdder.create(this.getHost().getItem(),this.getAreaBroker().getItemPanelArea())}})}),define("taoMediaManager/qtiCreator/plugins/menu/preview",["jquery","i18n","core/plugin","ui/hider","taoMediaManager/previewer/adapter/item/qtiSharedStimulusItem","tpl!taoQtiItem/qtiCreator/plugins/button"],function($,__,pluginFactory,hider,previewerFactory,buttonTpl){'use strict';return pluginFactory({name:"preview",init:function init(){var _this7=this,SharedStimulusCreator=this.getHost();SharedStimulusCreator.on("preview",function(id){previewerFactory.init(id,{readOnly:!1,fullPage:!0})});var sharedStimulusConfig=SharedStimulusCreator.getConfig();sharedStimulusConfig.properties.previewEnabled&&(this.$element=$(buttonTpl({icon:"preview",title:__("Preview the item"),text:__("Preview"),cssClass:"preview-trigger",testId:"preview-the-asset"})).on("click",function(e){$(document).trigger("open-preview.qti-item"),e.preventDefault(),_this7.disable(),SharedStimulusCreator.trigger("preview",SharedStimulusCreator.getSharedStimulusId()),_this7.enable()}))},render:function render(){var $container=this.getAreaBroker().getMenuArea();$container.append(this.$element)},destroy:function destroy(){this.$element.remove()},enable:function enable(){this.$element.removeProp("disabled").removeClass("disabled")},disable:function disable(){this.$element.prop("disabled",!0).addClass("disabled")},show:function show(){hider.show(this.$element)},hide:function hide(){hider.hide(this.$element)}})}),define("taoMediaManager/qtiCreator/plugins/menu/save",["jquery","i18n","core/plugin","ui/hider","tpl!taoQtiItem/qtiCreator/plugins/button"],function($,__,pluginFactory,hider,buttonTpl){'use strict';return pluginFactory({name:"save",init:function init(){var _this8=this,sharedStimulusCreator=this.getHost();this.$element=$(buttonTpl({icon:"save",title:__("Save the asset"),text:__("Save"),cssClass:"save-trigger",testId:"save-the-asset"})).on("click",function(e){e.preventDefault(),_this8.disable(),$("#item-editor-panel").trigger("beforesave.qti-creator"),sharedStimulusCreator.trigger("save")}),this.hide(),this.disable(),sharedStimulusCreator.on("ready saved error",function(){_this8.enable()})},render:function render(){var $container=this.getAreaBroker().getMenuArea();$container.append(this.$element),this.show()},destroy:function destroy(){this.$element.remove()},enable:function enable(){this.$element.removeProp("disabled").removeClass("disabled")},disable:function disable(){this.$element.prop("disabled",!0).addClass("disabled")},show:function show(){hider.show(this.$element)},hide:function hide(){hider.hide(this.$element)}})}),define("taoMediaManager/qtiCreator/plugins/navigation/back",["jquery","i18n","core/plugin","ui/hider","tpl!taoQtiItem/qtiCreator/plugins/button"],function($,__,pluginFactory,hider,buttonTpl){'use strict';return pluginFactory({name:"back",init:function init(){var sharedStimulusCreator=this.getHost();sharedStimulusCreator.on("exit",function(){window.history.back()}),this.$element=$(buttonTpl({icon:"left",title:__("Back to Manage Assets"),text:__("Manage Assets"),cssClass:"back-action",testId:"manage-assets"})).on("click",function(e){e.preventDefault(),sharedStimulusCreator.trigger("exit")}),this.hide()},render:function render(){var $container=this.getAreaBroker().getMenuLeftArea();$container.append(this.$element),this.show()},destroy:function destroy(){this.$element.remove()},enable:function enable(){this.$element.removeProp("disabled").removeClass("disabled")},disable:function disable(){this.$element.prop("disabled",!0).addClass("disabled")},show:function show(){hider.show(this.$element)},hide:function hide(){hider.hide(this.$element)}})}),define("taoMediaManager/qtiCreator/renderers/Figcaption",["lodash","taoQtiItem/qtiCommonRenderer/renderers/Figcaption"],function(_,Figcaption){'use strict';var CreatorFigcaption=_.clone(Figcaption);return CreatorFigcaption}),define("taoMediaManager/qtiCreator/widgets/static/figure/states/Active",["taoQtiItem/qtiCreator/widgets/states/factory","taoQtiItem/qtiCreator/widgets/static/states/Active","tpl!taoQtiItem/qtiCreator/tpl/forms/static/figure","taoQtiItem/qtiCreator/widgets/helpers/formElement","taoQtiItem/qtiCreator/widgets/static/helpers/inline","ui/figure/FigureStateActive"],function(stateFactory,ActiveState,formTpl,formElement,inlineHelper,FigureStateActive){'use strict';return FigureStateActive(stateFactory,ActiveState,formTpl,formElement,inlineHelper)}),define("taoMediaManager/qtiCreator/widgets/static/figure/states/states",["taoQtiItem/qtiCreator/widgets/states/factory","taoQtiItem/qtiCreator/widgets/static/states/states","taoQtiItem/qtiCreator/widgets/static/figure/states/Sleep","taoMediaManager/qtiCreator/widgets/static/figure/states/Active"],function(factory,states){return factory.createBundle(states,arguments)}),define("taoMediaManager/qtiCreator/widgets/static/figure/Widget",["jquery","lodash","taoQtiItem/qtiCreator/widgets/static/Widget","taoMediaManager/qtiCreator/widgets/static/figure/states/states","taoQtiItem/qtiCreator/widgets/static/helpers/widget","tpl!taoQtiItem/qtiCreator/tpl/toolbars/media","taoQtiItem/qtiCreator/widgets/static/helpers/inline","ui/mediaEditor/plugins/mediaAlignment/helper"],function($,_,Widget,states,helper,toolbarTpl,inlineHelper,alignmentHelper){'use strict';var FigureWidget=Widget.clone();return FigureWidget.initCreator=function(options){var _this9=this,figure=this.element,img=_.find(figure.getBody().elements,function(elem){return elem.is("img")});this.registerStates(states),Widget.initCreator.call(this),inlineHelper.togglePlaceholder(this),alignmentHelper.initAlignment(this),inlineHelper.checkFileExists(this,img,"src",options.baseUrl),$("#item-editor-scope").on("filedelete.resourcemgr.".concat(this.element.serial),function(e,src){_this9.getAssetManager().resolve(img.attr("src"))===_this9.getAssetManager().resolve(src)&&(img.attr("src",""),inlineHelper.togglePlaceholder(_this9))})},FigureWidget.destroy=function(){$("#item-editor-scope").off(".".concat(this.element.serial))},FigureWidget.getRequiredOptions=function(){return["baseUrl","uri","lang","mediaManager","assetManager"]},FigureWidget.buildContainer=function(){helper.buildBlockContainer(this);var img=_.find(this.element.getBody().elements,function(elem){return elem.is("img")}),$img=this.$original.find("img");return $img.length&&(this.$container.css({width:img.attr("width")}),$img.attr("width","100%"),$img.removeAttr("style")),this},FigureWidget.createToolbar=function(){return helper.createToolbar(this,toolbarTpl),this},FigureWidget}),define("taoMediaManager/qtiCreator/renderers/Figure",["lodash","taoQtiItem/qtiCommonRenderer/renderers/Figure","taoMediaManager/qtiCreator/widgets/static/figure/Widget"],function(_,Figure,FigureWidget){'use strict';var CreatorFigure=_.clone(Figure);return CreatorFigure.render=function(figure,options){var imageElem=_.find(figure.getBody().elements,function(elem){return elem.is("img")});options=options||{},options.baseUrl=this.getOption("baseUrl"),options.uri=this.getOption("uri"),options.lang=this.getOption("lang"),options.mediaManager=this.getOption("mediaManager"),options.assetManager=this.getAssetManager(),options.state=imageElem.metaData.widget&&imageElem.metaData.widget.getCurrentState().name,FigureWidget.build(figure,Figure.getContainer(figure),this.getOption("bodyElementOptionForm"),options)},CreatorFigure}),define("taoMediaManager/qtiCreator/widgets/static/img/states/Active",["taoQtiItem/qtiCreator/widgets/states/factory","taoQtiItem/qtiCreator/widgets/static/states/Active","tpl!taoQtiItem/qtiCreator/tpl/forms/static/img","taoQtiItem/qtiCreator/widgets/helpers/formElement","taoQtiItem/qtiCreator/widgets/static/helpers/inline","ui/image/ImgStateActive"],function(stateFactory,ActiveState,formTpl,formElement,inlineHelper,ImgStateActive){'use strict';return ImgStateActive(stateFactory,ActiveState,formTpl,formElement,inlineHelper)}),define("taoMediaManager/qtiCreator/widgets/static/img/states/states",["taoQtiItem/qtiCreator/widgets/states/factory","taoQtiItem/qtiCreator/widgets/static/states/states","taoQtiItem/qtiCreator/widgets/static/img/states/Sleep","taoMediaManager/qtiCreator/widgets/static/img/states/Active"],function(factory,states){'use strict';return factory.createBundle(states,arguments)}),define("taoMediaManager/qtiCreator/widgets/static/img/Widget",["jquery","taoQtiItem/qtiCreator/widgets/static/Widget","taoMediaManager/qtiCreator/widgets/static/img/states/states","taoQtiItem/qtiCreator/widgets/static/helpers/widget","tpl!taoQtiItem/qtiCreator/tpl/toolbars/media","taoQtiItem/qtiCreator/widgets/static/helpers/inline","ui/mediaEditor/plugins/mediaAlignment/helper"],function($,Widget,states,helper,toolbarTpl,inlineHelper,alignmentHelper){'use strict';var ImgWidget=Widget.clone();return ImgWidget.initCreator=function(options){var _this10=this,img=this.element;this.registerStates(states),Widget.initCreator.call(this),inlineHelper.togglePlaceholder(this),alignmentHelper.initAlignment(this),inlineHelper.checkFileExists(this,img,"src",options.baseUrl),$("#item-editor-scope").on("filedelete.resourcemgr.".concat(this.element.serial),function(e,src){_this10.getAssetManager().resolve(img.attr("src"))===_this10.getAssetManager().resolve(src)&&(img.attr("src",""),inlineHelper.togglePlaceholder(self))})},ImgWidget.destroy=function(){$("#item-editor-scope").off(".".concat(this.element.serial))},ImgWidget.getRequiredOptions=function(){return["baseUrl","uri","lang","mediaManager","assetManager"]},ImgWidget.buildContainer=function(){return helper.buildInlineContainer(this),this.$container.css({width:this.element.attr("width"),height:this.element.attr("height")}),this.$original[0]&&(this.$original[0].setAttribute("width","100%"),this.$original[0].removeAttribute("height")),this},ImgWidget.createToolbar=function(){return helper.createToolbar(this,toolbarTpl),this},ImgWidget}),define("taoMediaManager/qtiCreator/renderers/Img",["lodash","taoQtiItem/qtiCommonRenderer/renderers/Img","taoMediaManager/qtiCreator/widgets/static/img/Widget"],function(_,Renderer,Widget){'use strict';var CreatorImg=_.clone(Renderer);return CreatorImg.render=function(img,options){var $container=Renderer.getContainer(img);return $container.parent("figure").length?CreatorImg:void(options=options||{},options.baseUrl=this.getOption("baseUrl"),options.uri=this.getOption("uri"),options.lang=this.getOption("lang"),options.mediaManager=this.getOption("mediaManager"),options.assetManager=this.getAssetManager(),Widget.build(img,Renderer.getContainer(img),this.getOption("bodyElementOptionForm"),options))},CreatorImg}),define("tpl!taoMediaManager/qtiCreator/tpl/forms/item",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){function program1(depth0,data){var stack1,helper,options,buffer="";return buffer+="\n    <div class=\"panel\">\n        <label for=\"xml:lang\">\n            "+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Language",options):helperMissing.call(depth0,"__","Language",options)))+"\n        </label>\n        <span class=\"icon-help tooltipstered\" data-tooltip=\"~ .tooltip-content:first\" data-tooltip-theme=\"info\"></span>\n        <span class=\"tooltip-content\">\n            "+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Define item language.",options):helperMissing.call(depth0,"__","Define item language.",options)))+"\n        </span>\n        <select name=\"xml:lang\" class=\"select2\" data-has-search=\"false\">\n            ",stack1=helpers.each.call(depth0,depth0&&depth0.languagesList,{hash:{},inverse:self.noop,fn:self.programWithDepth(2,program2,data,depth0),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+="\n        </select>\n    </div>\n",buffer}function program2(depth0,data,depth1){var stack1,helper,options,buffer="";return buffer+="\n                <option value=\""+escapeExpression((stack1=null==data||!1===data?data:data.key,"function"===_typeof(stack1)?stack1.apply(depth0):stack1))+"\"",stack1=(helper=helpers.equal||depth1&&depth1.equal,options={hash:{},inverse:self.noop,fn:self.program(3,program3,data),data:data},helper?helper.call(depth0,null==data||!1===data?data:data.key,depth1&&depth1["xml:lang"],options):helperMissing.call(depth0,"equal",null==data||!1===data?data:data.key,depth1&&depth1["xml:lang"],options)),(stack1||0===stack1)&&(buffer+=stack1),buffer+=">"+escapeExpression("function"===_typeof(depth0)?depth0.apply(depth0):depth0)+"</option>\n            ",buffer}function program3(){return" selected=\"selected\""}this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var stack1,escapeExpression=this.escapeExpression,self=this,helperMissing=helpers.helperMissing;return stack1=helpers["if"].call(depth0,depth0&&depth0.languagesList,{hash:{},inverse:self.noop,fn:self.program(1,program1,data),data:data}),stack1||0===stack1?stack1:""})}),define("taoMediaManager/qtiCreator/widgets/item/states/Active",["lodash","taoQtiItem/qtiCreator/widgets/states/factory","taoMediaManager/qtiCreator/widgets/states/Active","tpl!taoMediaManager/qtiCreator/tpl/forms/item","taoQtiItem/qtiCreator/widgets/helpers/formElement"],function(_,stateFactory,Active,formTpl,formElement){'use strict';var ItemStateActive=stateFactory.create(Active,function(){var _widget=this.widget,item=_widget.element,$form=_widget.$form;$form.html(formTpl({"xml:lang":item.attr("xml:lang"),languagesList:item.data("languagesList")})),formElement.initWidget($form),formElement.setChangeCallbacks($form,item,{"xml:lang":formElement.getAttributeChangeCallback()})},_.noop);return ItemStateActive}),define("taoMediaManager/qtiCreator/widgets/item/states/states",["taoQtiItem/qtiCreator/widgets/states/factory","taoMediaManager/qtiCreator/widgets/item/states/Active"],function(factory){'use strict';return factory.createBundle(arguments)}),define("taoMediaManager/qtiCreator/widgets/item/Widget",["lodash","i18n","jquery","core/promise","util/url","taoQtiItem/qtiCreator/widgets/Widget","taoMediaManager/qtiCreator/widgets/item/states/states","taoQtiItem/qtiItem/core/Element","taoMediaManager/qtiCreator/helper/creatorRenderer","taoQtiItem/qtiCreator/model/helper/container","taoQtiItem/qtiCreator/editor/gridEditor/content","taoQtiItem/qtiCreator/helper/xmlRenderer","taoQtiItem/qtiCreator/helper/devTools","taoMediaManager/qtiCreator/widgets/static/text/Widget","taoQtiItem/qtiItem/helper/xmlNsHandler","taoQtiItem/qtiCreator/editor/jquery.gridEditor"],function(_,__,$,Promise,urlUtil,Widget,states,Element,creatorRenderer,containerHelper,contentHelper,xmlRenderer,devTools,TextWidget){'use strict';var ItemWidget=Widget.clone();ItemWidget.initCreator=function(config){var self=this;if(this.registerStates(states),Widget.initCreator.call(this),!config||!config.uri)throw new Error("missing required config parameter uri in item widget initialization");return this.saveItemUrl=config.saveItemUrl,this.renderer=config.renderer,this.itemUri=config.uri,new Promise(function(resolve){self.initTextWidgets(function(){this.initGridEditor(),this.debug({state:!1,xml:!1}),resolve()})})},ItemWidget.buildContainer=function(){this.$container=this.$original},ItemWidget.initUiComponents=function(){var element=this.element,$saveBtn=$("#save-trigger");this.on("metaChange",function(data){if(data.element.getSerial()===element.getSerial()&&"invalid"===data.key){var invalid=element.data("invalid");_.size(invalid)?$saveBtn.addClass("disabled"):$saveBtn.removeClass("disabled")}},!0)},ItemWidget.initGridEditor=function(){var self=this,item=this.element,$itemBody=this.$container.find(".qti-itemBody"),$itemEditorPanel=$("#item-editor-panel");$itemBody.gridEditor(),$itemBody.gridEditor("resizable"),$itemBody.gridEditor("addInsertables",$(".tool-list > [data-qti-class]:not(.disabled)"),{helper:function helper(){return $(this).find(".icon").clone().addClass("dragging")}}),$itemBody.on("beforedragoverstart.gridEdit",function(){$itemEditorPanel.addClass("dragging"),$itemBody.removeClass("hoverable").addClass("inserting")}).on("dragoverstop.gridEdit",function(){$itemEditorPanel.removeClass("dragging"),$itemBody.addClass("hoverable").removeClass("inserting")}).on("dropped.gridEdit.insertable",function(e,qtiClass,$placeholder){$placeholder.removeAttr("id"),"rubricBlock"===qtiClass&&($placeholder=$placeholder.parent(".col-12").parent(".grid-row")),$placeholder.addClass("widget-box"),$placeholder.attr({"data-new":!0,"data-qti-class":qtiClass});var $widget=$placeholder.parent().closest(".widget-box, .qti-item"),$editable=$placeholder.closest("[data-html-editable], .qti-itemBody"),widget=$widget.data("widget"),element=widget.element,container=Element.isA(element,"_container")?element:element.getBody();if(!element||!$editable.length)throw new Error("cannot create new element");containerHelper.createElements(container,contentHelper.getContent($editable),function(newElts){creatorRenderer.get().load(function(){var _this11=this;_.forEach(newElts,function(elt){var $eltWidget,eltwWdget,$colParent=$placeholder.parent();elt.setRenderer(_this11),Element.isA(elt,"_container")?($colParent.empty(),$colParent.html(elt.render()),eltwWdget=self.initTextWidget(elt,$colParent),$eltWidget=eltwWdget.$container):(elt.render($placeholder),elt.postRender(),eltwWdget=elt.data("widget"),$eltWidget=Element.isA(elt,"blockInteraction")?eltwWdget.$container:eltwWdget.$original),$eltWidget.trigger("contentChange.gridEdit"),$eltWidget.trigger("resize.gridEdit"),Element.isA(elt,"interaction")?eltwWdget.changeState("question"):eltwWdget.changeState("active")})},this.getUsedClasses())})}).on("resizestop.gridEdit",function(){item.body($itemBody.gridEditor("getContent"))})};var _detachElements=function(container,elements){var containerElements={};return _.each(elements,function(elementSerial){containerElements[elementSerial]=container.elements[elementSerial],delete container.elements[elementSerial]}),containerElements};return ItemWidget.initTextWidgets=function(callback){var self=this,item=this.element,$originalContainer=this.$container,i=1,subContainers=[];callback=callback||_.noop,$originalContainer.find(".qti-itemBody > .grid-row").each(function(){var $row=$(this);$row.hasClass("widget-box")||$row.children().each(function(){var $col=$(this),isTextBlock=!1;$col.contents().each(function(){if(3===this.nodeType&&this.nodeValue&&this.nodeValue.trim())return isTextBlock=!0,!1});var $widget=$col.children();(1<$widget.length||!$widget.hasClass("widget-blockInteraction"))&&($widget.hasClass("colrow")?$widget.each(function(){var $subElement=$(this),$subWidget=$subElement.children();(1<$subWidget.length||!$subWidget.hasClass("widget-blockInteraction"))&&($subElement.attr("data-text-block-id","text-block-".concat(i)),i++)}):isTextBlock=!0),isTextBlock&&($col.attr("data-text-block-id","text-block-".concat(i)),i++)})});var $clonedContainer=$originalContainer.clone();$clonedContainer.find(".qti-itemBody > .grid-row [data-text-block-id]").each(function(){var $originalTextBlock=$(this),textBlockId=$originalTextBlock.data("text-block-id"),$subContainer=$originalTextBlock.clone(),subContainerElements=contentHelper.serializeElements($subContainer),subContainerBody=$subContainer.html();$originalTextBlock.removeAttr("data-text-block-id").html("{{_container:new}}"),subContainers.push({body:subContainerBody,elements:subContainerElements,$original:$originalContainer.find("[data-text-block-id=\"".concat(textBlockId,"\"]")).removeAttr("data-text-block-id")})}),contentHelper.serializeElements($clonedContainer);var serializedItemBody=$clonedContainer.find(".qti-itemBody").html(),itemBody=item.getBody();subContainers.length?containerHelper.createElements(itemBody,serializedItemBody,function(newElts){if(_.size(newElts)!==subContainers.length)throw new Error("number of sub-containers mismatch");else _.each(newElts,function(container){var containerData=subContainers.shift(),containerElements=_detachElements(itemBody,containerData.elements);container.setElements(containerElements,containerData.body),self.initTextWidget(container,containerData.$original)}),_.defer(function(){callback.call(self)})}):callback.call(self)},ItemWidget.initTextWidget=function(container,$col){return TextWidget.build(container,$col,this.renderer.getOption("textOptionForm"),{})},ItemWidget.debug=function(options){if(options=options||{},options.state&&devTools.listenStateChange(),options.xml){var $code=$("<code>",{class:"language-markup"}),$pre=$("<pre>",{class:"line-numbers"}).append($code);$("#item-editor-wrapper").append($pre),devTools.liveXmlPreview(this.element,$code)}},ItemWidget}),define("tpl!taoMediaManager/qtiCreator/renderers/tpl/wrap",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){return this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{},"<div class=\"grid-row\"><div class=\"col-12\"></div></div>"})}),define("taoMediaManager/qtiCreator/renderers/Item",["jquery","lodash","taoQtiItem/qtiCommonRenderer/renderers/Item","taoMediaManager/qtiCreator/widgets/item/Widget","tpl!taoQtiItem/qtiCreator/tpl/item","tpl!taoMediaManager/qtiCreator/renderers/tpl/wrap"],function($,_,CommonRenderer,Widget,tpl,wrapTpl){'use strict';var CreatorItem=_.clone(CommonRenderer),_normalizeItemBody=function($itemBody){return $itemBody.children().each(function(){var $child=$(this);$child.hasClass("grid-row")||$child.hasClass("qti-infoControl")||$child.wrap(wrapTpl())}),$itemBody};return CreatorItem.template=tpl,CreatorItem.render=function(item,options){var $itemContainer=CommonRenderer.getContainer(item);return _normalizeItemBody($itemContainer.find(".qti-itemBody")),options=options||{},options.state="active",options.renderer=this,Widget.build(item,$itemContainer,this.getOption("itemOptionForm"),options)},CreatorItem}),define("taoMediaManager/qtiCreator/widgets/static/object/states/Active",["lodash","jquery","i18n","taoQtiItem/qtiCreator/widgets/states/factory","taoQtiItem/qtiCreator/widgets/static/states/Active","tpl!taoQtiItem/qtiCreator/tpl/forms/static/object","taoQtiItem/qtiCreator/widgets/helpers/formElement","taoQtiItem/qtiCreator/widgets/static/helpers/inline","ui/mediaEditor/mediaEditorComponent","ui/previewer","ui/resourcemgr","ui/tooltip"],function(_,$,__,stateFactory,Active,formTpl,formElement,inlineHelper,mediaEditorComponent){'use strict';var _Mathmin=Math.min,mediaEditor=null,$panelObjectSize=null,$panelMediaSize=null,_config={renderingThrottle:1e3,fileFilters:"image/jpeg,image/png,image/gif,image/svg+xml,video/mp4,video/avi,video/ogv,video/mpeg,video/ogg,video/quicktime,video/webm,video/x-ms-wmv,video/x-flv,audio/mp3,audio/vnd.wav,audio/ogg,audio/vorbis,audio/webm,audio/mpeg,application/ogg,audio/aac,application/pdf"},ObjectStateActive=stateFactory.extend(Active,function(){this.initForm()},function(){mediaEditor&&mediaEditor.destroy(),mediaEditor=null,$panelObjectSize=null,$panelMediaSize=null,this.widget.$original.off("playerready"),this.widget.$form.empty()}),refreshRendering=_.throttle(function(widget){var obj=widget.element,$container=widget.$original,previewOptions={url:obj.renderer.resolveUrl(obj.attr("data")),mime:obj.attr("type")};obj.attr("height")&&(previewOptions.height=obj.attr("height")),obj.attr("width")&&(previewOptions.width=obj.attr("width")),previewOptions.url&&previewOptions.mime&&$container.previewer(previewOptions)},_config.renderingThrottle),setMediaSizeEditor=function(widget){var _Mathmax=Math.max,_Mathround=Math.round,qtiObject=widget.element,type=qtiObject.attr("type");if(/video/.test(type)){var $container=widget.$original,mediaplayer=$container.data("player"),width=qtiObject.attr("width"),height=qtiObject.attr("height");if(!/%/.test(width)){var originalSize=mediaplayer.getMediaOriginalSize();if(!originalSize.width)return;var containerWidth=$container.closest(".widget-textBlock").width();if(!width)width=_Mathround(100/(containerWidth/originalSize.width)),height=0;else if(height){var scaleHeight=(_Mathmax(height||0,200)-$container.find(".mediaplayer .controls").height())/originalSize.height,scaleWidth=_Mathmax(width||0,200)/originalSize.width,scale=_Mathmin(scaleHeight,scaleWidth);width=_Mathround(100/(containerWidth/(scale*originalSize.width))),qtiObject.removeAttr("height"),height=0}}var onChange=_.debounce(function(nMedia){if(qtiObject.attr("width")!=="".concat(nMedia.width,"%")){var newWidth="".concat(_Mathround(nMedia.width),"%");qtiObject.attr("width",newWidth),mediaplayer.resize(newWidth,"auto")}},200);mediaEditor&&mediaEditor.destroy(),mediaEditor=mediaEditorComponent($panelMediaSize,{$node:$container.find(".mediaplayer .media"),$container:$container,type:qtiObject.attr("type"),width:width,height:height,responsive:!0},{mediaDimension:{active:!0,showResponsiveToggle:!1}}).on("change",onChange)}},hideShowPanels=function(type){/video/.test(type)?($panelObjectSize.hide(),$panelMediaSize.show()):(mediaEditor&&mediaEditor.destroy(),$panelObjectSize.show(),$panelMediaSize.hide())},_initUpload=function(widget){var $form=widget.$form,options=widget.options,qtiObject=widget.element,$uploadTrigger=$form.find("[data-role=\"upload-trigger\"]"),$src=$form.find("input[name=src]"),_openResourceMgr=function(){$uploadTrigger.resourcemgr({title:__("Please select a media file from the resource manager. You can add files from your computer with the button \"Add file(s)\"."),appendContainer:options.mediaManager.appendContainer,mediaSourcesUrl:options.mediaManager.mediaSourcesUrl,browseUrl:options.mediaManager.browseUrl,uploadUrl:options.mediaManager.uploadUrl,deleteUrl:options.mediaManager.deleteUrl,downloadUrl:options.mediaManager.downloadUrl,fileExistsUrl:options.mediaManager.fileExistsUrl,params:{uri:options.uri,lang:options.lang,filters:_config.fileFilters},pathParam:"path",path:options.mediaManager.path,root:options.mediaManager.root,select:function select(e,files){var file,type;files&&files.length&&(file=files[0].file,type=files[0].mime,qtiObject.attr("type",type),$src.val(file).trigger("change"))},open:function open(){$src.data("$tooltip")&&$src.blur().data("$tooltip").hide()},close:function close(){$src.blur()}})};$uploadTrigger.on("click",_openResourceMgr),$src.val()||_openResourceMgr()};return ObjectStateActive.prototype.initForm=function(){var _widget=this.widget,$form=_widget.$form,qtiObject=_widget.element,baseUrl=_widget.options.baseUrl,$container=_widget.$original;$form.html(formTpl({baseUrl:baseUrl||"",src:qtiObject.attr("data"),alt:qtiObject.attr("alt"),height:qtiObject.attr("height"),width:qtiObject.attr("width")})),_initUpload(_widget),formElement.initWidget($form),$panelObjectSize=$(".size-panel",$form),$panelMediaSize=$(".media-size-panel",$form),hideShowPanels(qtiObject.attr("type")),$container.off("playerready").on("playerready",function(){setMediaSizeEditor(_widget)}),formElement.setChangeCallbacks($form,qtiObject,{src:function src(object,value){value!==qtiObject.attr("data")&&(qtiObject.attr("data",value),qtiObject.removeAttr("width"),qtiObject.removeAttr("height"),$form.find("input[name=width]").val(""),$form.find("input[name=height]").val(""),$container.removeData("ui.previewer"),hideShowPanels(qtiObject.attr("type")),inlineHelper.togglePlaceholder(_widget),refreshRendering(_widget))},width:function width(object,value){var val=parseInt(value,10);_.isNaN(val)?qtiObject.removeAttr("width"):qtiObject.attr("width",val),refreshRendering(_widget)},height:function height(object,value){var val=parseInt(value,10);_.isNaN(val)?qtiObject.removeAttr("height"):qtiObject.attr("height",val),refreshRendering(_widget)},alt:function alt(qtiObjectAlt,value){qtiObjectAlt.attr("alt",value)},align:function align(qtiObjectAlign,value){inlineHelper.positionFloat(_widget,value)}})},ObjectStateActive}),define("taoMediaManager/qtiCreator/widgets/static/object/states/states",["taoQtiItem/qtiCreator/widgets/states/factory","taoQtiItem/qtiCreator/widgets/static/states/states","taoQtiItem/qtiCreator/widgets/static/object/states/Sleep","taoMediaManager/qtiCreator/widgets/static/object/states/Active"],function(factory,states){'use strict';return factory.createBundle(states,arguments)}),define("taoMediaManager/qtiCreator/widgets/static/object/Widget",["taoQtiItem/qtiCreator/widgets/static/Widget","taoMediaManager/qtiCreator/widgets/static/object/states/states","taoQtiItem/qtiCreator/widgets/static/helpers/widget","tpl!taoQtiItem/qtiCreator/tpl/toolbars/media","taoQtiItem/qtiCreator/widgets/static/helpers/inline"],function(Widget,states,helper,toolbarTpl,inlineHelper){'use strict';var ObjectWidget=Widget.clone();return ObjectWidget.initCreator=function(){this.registerStates(states),Widget.initCreator.call(this),inlineHelper.togglePlaceholder(this)},ObjectWidget.getRequiredOptions=function(){return["baseUrl","uri","lang","mediaManager"]},ObjectWidget.buildContainer=function(){return helper.buildBlockContainer(this),this},ObjectWidget.createToolbar=function(){return helper.createToolbar(this,toolbarTpl),this},ObjectWidget}),define("taoMediaManager/qtiCreator/renderers/Object",["lodash","taoQtiItem/qtiCommonRenderer/renderers/Object","taoMediaManager/qtiCreator/widgets/static/object/Widget"],function(_,Renderer,Widget){'use strict';var CreatorObject=_.clone(Renderer);return CreatorObject.render=function(object,options){Renderer.render(object),options=options||{},options.baseUrl=this.getOption("baseUrl"),options.uri=this.getOption("uri"),options.lang=this.getOption("lang"),options.mediaManager=this.getOption("mediaManager"),options.assetManager=this.getAssetManager(),Widget.build(object,Renderer.getContainer(object),this.getOption("bodyElementOptionForm"),options)},CreatorObject}),define("taoMediaManager/qtiCreator/widgets/static/table/states/Active",["lodash","jquery","i18n","ckeditor","ui/tableModel","taoQtiItem/qtiCreator/widgets/states/factory","taoMediaManager/qtiCreator/widgets/static/states/Active","taoQtiItem/qtiCreator/widgets/static/table/components/tableActions","taoMediaManager/qtiCreator/editor/ckEditor/htmlEditor","taoQtiItem/qtiCreator/editor/gridEditor/content","taoQtiItem/qtiCreator/widgets/helpers/formElement","tpl!taoQtiItem/qtiCreator/tpl/forms/static/table"],function(_,$,__,ckEditor,tableModelFactory,stateFactory,Active,tableActionsFactory,htmlEditor,contentHelper,formElement,formTpl){'use strict';function getChangeCallback(container){return _.throttle(function(data){var $tableTagContent=$(data).children(),$pseudoContainer=$("<div>").html($tableTagContent),newBody=contentHelper.getContent($pseudoContainer);container.body(newBody)},400)}function addClassOnCurrentRow(editor,className){var currentCellPos=getCurrentCellPos(editor);if(currentCellPos){var $currentCol=tableModel.getRowCells(currentCellPos.y);$currentCol.addClass(className)}}function addClassOnCurrentCol(editor,className){var currentCellPos=getCurrentCellPos(editor);if(currentCellPos){var $currentCol=tableModel.getColCells(currentCellPos.x);$currentCol.addClass(className)}}function clearCellClasses($editable,className){$editable.find("th, td").removeClass(className)}function updateTable(editor,$editableContainer){tableModel.update(),1===tableModel.getRowCount()?rowActions.hideDelete():rowActions.showDelete(),1===tableModel.getColCount()?colActions.hideDelete():colActions.showDelete(),displayTableActions(editor,$editableContainer)}function hideTableActions(){colActions&&colActions.hide(),rowActions&&rowActions.hide()}function displayTableActions(editor,$tableContainer){var selectedCells=getSelection(editor);if(selectedCells&&1!==selectedCells.length)hideTableActions();else{var $currentCell=$(selectedCells[0].$);colActions.show().hAlignWith($currentCell,"center").vAlignWith($tableContainer,"top"),rowActions.show().hAlignWith($tableContainer,"left").vAlignWith($currentCell,"center")}}function getCurrentCellPos(editor){var selectedCells=getSelection(editor);if(selectedCells&&1===selectedCells.length){var currentCell=selectedCells[0].$;return{x:currentCell.cellIndex,y:currentCell.parentNode.rowIndex}}}function getSelection(editor){var selection=editor.getSelection(),tabletools=window.CKEDITOR.plugins.tabletools;if(selection&&tabletools)return tabletools.getSelectedCells(selection)}var tableModel,colActions,rowActions,css={deleteColRow:"hoverDelete",insertRowAfter:"insertRowAfter",insertColAfter:"insertColAfter",hAlignCenter:"table-center",hAlignRight:"table-right"},TableStateActive=stateFactory.extend(Active,function(){this.initForm(),this.buildEditor()},function(){this.widget.$form.empty(),this.destroyEditor()});return TableStateActive.prototype.initForm=function(){var _widget=this.widget,$form=_widget.$form,table=_widget.element,$container=_widget.$container,hAlignOptions=[{name:__("Left"),value:"left"},{name:__("Center"),value:"center",selected:table.hasClass(css.hAlignCenter)},{name:__("Right"),value:"right",selected:table.hasClass(css.hAlignRight)}];$form.html(formTpl({hAlignOptions:hAlignOptions})),formElement.initWidget($form),formElement.setChangeCallbacks($form,table,{hAlign:function hAlign(t,value){switch(hideTableActions(),t.removeClass(css.hAlignRight),t.removeClass(css.hAlignCenter),$container.removeClass("".concat(css.hAlignRight," ").concat(css.hAlignCenter)),value){case"center":{t.addClass(css.hAlignCenter),$container.addClass(css.hAlignCenter);break}case"right":{t.addClass(css.hAlignRight),$container.addClass(css.hAlignRight);break}}}})},TableStateActive.prototype.buildEditor=function(){var _widget=this.widget,container=_widget.element.getBody(),$itemPanel=_widget.getAreaBroker().getItemPanelArea(),$editableContainer=_widget.$container,$editable=$editableContainer.find(".qti-table-container"),$tablePropTrigger=$editableContainer.find("[data-role=\"cke-table-properties\"]"),areaBroker=_widget&&_widget.getAreaBroker&&_widget.getAreaBroker(),$toolbarArea=areaBroker&&areaBroker.getToolbarArea&&areaBroker.getToolbarArea();$editableContainer.attr("data-html-editable-container",!0),$editable.attr("data-html-editable",!0),htmlEditor.hasEditor($editableContainer)||htmlEditor.buildEditor($editableContainer,{placeholder:"",change:getChangeCallback(container),removePlugins:"magicline",data:{container:container,widget:_widget},blur:function blur(){_widget.changeState("sleep")}}),$editable.on("editorready.tableActive",function(event,editor){tableModel=tableModelFactory($editable.find("table")),$tablePropTrigger.on("click.tableActive",function(e){e.stopPropagation(),hideTableActions(),editor.execCommand("taoqtitableProperties")}),colActions=tableActionsFactory({insertCol:!0,deleteTitle:"Delete column"}).on("delete",function(){editor.execCommand("columnDelete"),updateTable(editor,$editableContainer),hideTableActions()}).on("deleteMouseEnter",function(){addClassOnCurrentCol(editor,css.deleteColRow)}).on("deleteMouseLeave",function(){clearCellClasses($editable,css.deleteColRow)}).on("insertCol",function(){editor.execCommand("columnInsertAfter"),clearCellClasses($editable,css.insertColAfter),this.trigger("insertColMouseEnter"),updateTable(editor,$editableContainer)}).on("insertColMouseEnter",function(){addClassOnCurrentCol(editor,css.insertColAfter)}).on("insertColMouseLeave",function(){clearCellClasses($editable,css.insertColAfter)}).render($itemPanel),rowActions=tableActionsFactory({insertRow:!0,deleteTitle:"Delete row"}).on("delete",function(){editor.execCommand("rowDelete"),updateTable(editor,$editableContainer),hideTableActions()}).on("deleteMouseEnter",function(){addClassOnCurrentRow(editor,css.deleteColRow)}).on("deleteMouseLeave",function(){clearCellClasses($editable,css.deleteColRow)}).on("insertRow",function(){editor.execCommand("rowInsertAfter"),clearCellClasses($editable,css.insertRowAfter),this.trigger("insertRowMouseEnter"),updateTable(editor,$editableContainer)}).on("insertRowMouseEnter",function(){addClassOnCurrentRow(editor,css.insertRowAfter)}).on("insertRowMouseLeave",function(){clearCellClasses($editable,css.insertRowAfter)}).render($itemPanel),displayTableActions(editor,$editableContainer),$editableContainer.on("keyup.tableActive mouseup.tableActive",function(){displayTableActions(editor,$editableContainer);var currentSelection=getSelection(editor),$toolbars=$toolbarArea.find(".cke_toolbar");1<currentSelection.length?($toolbars.eq(1).hide(),$toolbars.eq(2).hide()):($toolbars.eq(1).show(),$toolbars.eq(2).show())})}).on("editordestroyed.tableActive",function(){$tablePropTrigger.length&&$tablePropTrigger.off(".tableActive")})},TableStateActive.prototype.destroyEditor=function(){var _widget=this.widget,$editableContainer=_widget.$container,$editable=$editableContainer.find("[data-html-editable=\"true\"]");clearCellClasses($editable,css.insertColAfter),clearCellClasses($editable,css.insertRowAfter),clearCellClasses($editable,css.deleteColRow),htmlEditor.destroyEditor($editableContainer),$editableContainer.off(".tableActive"),$editable.off(".tableActive"),$editable.attr("data-html-editable",!1),$editableContainer.attr("data-html-editable-container",!1),tableModel=null,colActions&&(colActions.destroy(),colActions=null),rowActions&&(rowActions.destroy(),rowActions=null)},TableStateActive}),define("taoMediaManager/qtiCreator/widgets/static/table/states/states",["taoQtiItem/qtiCreator/widgets/states/factory","taoQtiItem/qtiCreator/widgets/static/states/states","taoQtiItem/qtiCreator/widgets/static/table/states/Sleep","taoMediaManager/qtiCreator/widgets/static/table/states/Active"],function(factory,states){'use strict';return factory.createBundle(states,arguments)}),define("taoMediaManager/qtiCreator/widgets/static/table/Widget",["jquery","taoQtiItem/qtiCreator/widgets/static/Widget","taoMediaManager/qtiCreator/widgets/static/table/states/states","taoQtiItem/qtiCreator/widgets/static/helpers/widget","tpl!taoQtiItem/qtiCreator/tpl/toolbars/table"],function($,Widget,states,helper,toolbarTpl){'use strict';var TableWidget=Widget.clone();return TableWidget.initCreator=function(){this.registerStates(states),Widget.initCreator.call(this)},TableWidget.buildContainer=function(){var table=this.element;return helper.buildBlockContainer(this),table.attr("class")&&this.$container.addClass(table.attr("class")),this},TableWidget.createToolbar=function(){var self=this,$tlb=$(toolbarTpl({serial:this.serial,state:"active"}));return this.$container.append($tlb),$tlb.find("[data-role=\"delete\"]").on("click.widget-box",function(e){e.stopPropagation(),self.changeState("deleting")}),this},TableWidget}),define("taoMediaManager/qtiCreator/renderers/Table",["lodash","taoQtiItem/qtiCommonRenderer/renderers/Table","taoMediaManager/qtiCreator/widgets/static/table/Widget","tpl!taoQtiItem/qtiCreator/tpl/table"],function(_,Renderer,Widget,tpl){'use strict';var CreatorTable=_.clone(Renderer);return CreatorTable.template=tpl,CreatorTable.render=function(table,options){Widget.build(table,Renderer.getContainer(table),this.getOption("bodyElementOptionForm"),options||{})},CreatorTable}),define("tpl!taoMediaManager/qtiXmlRenderer/tpl/item",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){function program1(depth0,data){var stack1,buffer="";return stack1=helpers["if"].call(depth0,null==data||!1===data?data:data.key,{hash:{},inverse:self.program(4,program4,data),fn:self.program(2,program2,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+=" ",buffer}function program2(depth0,data){var stack1,buffer="";return buffer+="xmlns:"+escapeExpression((stack1=null==data||!1===data?data:data.key,"function"===_typeof(stack1)?stack1.apply(depth0):stack1))+"=\""+escapeExpression("function"===_typeof(depth0)?depth0.apply(depth0):depth0)+"\"",buffer}function program4(depth0){var buffer="";return buffer+="xmlns=\""+escapeExpression("function"===_typeof(depth0)?depth0.apply(depth0):depth0)+"\"",buffer}function program6(depth0,data){var stack1,helper,options;return stack1=(helper=helpers.join||depth0&&depth0.join,options={hash:{},data:data},helper?helper.call(depth0,depth0&&depth0.attributes,"="," ","\"",options):helperMissing.call(depth0,"join",depth0&&depth0.attributes,"="," ","\"",options)),stack1||0===stack1?stack1:""}function program10(depth0,data){var stack1,helper,buffer="";return buffer+="\n        ",(helper=helpers.body)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.body,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),(stack1||0===stack1)&&(buffer+=stack1),buffer+="\n    ",buffer}this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var stack1,buffer="",escapeExpression=this.escapeExpression,self=this,helperMissing=helpers.helperMissing;return buffer+="<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<div\n    ",stack1=helpers.each.call(depth0,depth0&&depth0.namespaces,{hash:{},inverse:self.noop,fn:self.program(1,program1,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+="\n    ",stack1=helpers["if"].call(depth0,depth0&&depth0.attributes,{hash:{},inverse:self.noop,fn:self.program(6,program6,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+=">\n    ",stack1=helpers["if"].call(depth0,depth0&&depth0.empty,{hash:{},inverse:self.program(10,program10,data),fn:self.program(8,function(){return"\n        <div class=\"empty\"></div>\n    "},data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+="\n</div>",buffer})}),define("taoMediaManager/qtiXmlRenderer/renderers/Item",["lodash","tpl!taoMediaManager/qtiXmlRenderer/tpl/item"],function(_,tpl){'use strict';return{qtiClass:"assessmentItem",template:tpl,getData:function(item,data){var defaultData={class:data.attributes.class||"",namespaces:item.getNamespaces(),schemaLocations:"",xsi:"xsi:",empty:item.isEmpty()};return _.forIn(item.getSchemaLocations(),function(url,uri){defaultData.schemaLocations+="".concat(uri," ").concat(url," ")}),defaultData.schemaLocations=defaultData.schemaLocations.trim(),data=_.merge({},data,defaultData),delete data.attributes.title,delete data.attributes.adaptive,delete data.attributes.timeDependent,delete data.attributes.identifier,data.attributes=_.mapValues(data.attributes,function(val){return _.isString(val)?_.escape(val):val}),data}}}),function(c){var d=document,s=d.createElement("style");s.type="text/css",d.getElementsByTagName("head")[0].appendChild(s),s.styleSheet?s.styleSheet.cssText=c:s.appendChild(d.createTextNode(c))}(".previewer{position:relative}.previewer iframe{min-height:400px;width:100%}.previewer .previewer-component{background-color:white;text-align:initial}.previewer .previewer-component .item-previewer-scope{height:calc(100vh - 250px)}.previewer .previewer-component .item-previewer-scope .action-bar,.previewer .previewer-component .item-previewer-scope .test-sidebar{display:none}.previewer.no-background{background:none}#item-editor-scope .left-bar .tool-group ._accordion{display:none}#item-editor-scope .focus-border{box-shadow:1px 1px 3px 2px #3e7da7}#item-editor-scope .qti-itemBody.item-editor-drop-area{margin-top:0}#item-editor-scope .qti-item{padding:20px}#item-editor-scope .item-editor-sidebar #item-editor-font-size-changer .icon-smaller,#item-editor-scope .item-editor-sidebar #item-editor-font-size-changer .icon-larger{background:none;color:black;height:21px;width:20px}#item-editor-scope .item-editor-sidebar #item-editor-font-size-changer .icon-smaller{margin-left:30px}#item-editor-scope .item-editor-sidebar #item-editor-font-size-changer .icon-smaller:before{font-size:1.2rem}#item-editor-scope .item-editor-sidebar #item-editor-font-size-changer .icon-larger:before{font-size:1.8rem}#item-editor-scope .item-editor-sidebar .item-editor-color-picker .color-trigger{background:none}#item-editor-scope .item-editor-sidebar .item-editor-color-picker .reset-button{top:0}#item-editor-scope .item-editor-sidebar .reset-group .reset-button{background:none;color:black}div.item-editor-item{border-color:transparent}\n\n/*# sourceMappingURL=../../../taoMediaManager/views/css/media.css.map */"),define("taoMediaManager/loader/taoMediaManager.bundle",function(){}),define("taoMediaManager/loader/taoMediaManager.min",["taoItems/loader/taoItemsRunner.min","taoTests/loader/taoTestsRunner.min","taoQtiItem/loader/taoQtiItemRunner.min","taoQtiItem/loader/taoQtiItem.min","taoQtiTestPreviewer/loader/qtiPreviewer.min"],function(){});
//# sourceMappingURL=taoMediaManager.min.js.map